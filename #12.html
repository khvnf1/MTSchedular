<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Timetable Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #111827;
            --bg-secondary-color: #1f2937;
            --bg-tertiary-color: #374151;
            --text-primary-color: #f3f4f6;
            --text-secondary-color: #d1d5db;
            --border-color: #4b5563;
            --border-focus-color: #6366f1;
            /* New CSS variables for transparent colors and blur amount */
            --bg-secondary-color-transparent: rgba(31, 41, 55, 0.7);
            --current-blur-amount: 0px; /* Default no blur */
        }

        body.light-mode {
            --bg-color: #f9fafb;
            --bg-secondary-color: #ffffff;
            --bg-tertiary-color: #e5e7eb;
            --text-primary-color: #111827;
            --text-secondary-color: #4b5563;
            --border-color: #d1d5db;
            --border-focus-color: #4f46e5;
            /* Transparent colors for light mode */
            --bg-secondary-color-transparent: rgba(255, 255, 255, 0.7);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary-color);
            transition: background-color 0.3s ease, color 0.3s ease, background-image 0.5s ease-in-out; /* Added background-image transition */
            background-size: cover; /* Ensure background image covers the whole body */
            background-position: center; /* Center the background image */
            background-repeat: no-repeat; /* Do not repeat the background image */
            background-attachment: fixed; /* Keep background fixed when scrolling */
        }
        .timetable-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            grid-template-rows: auto repeat(6, minmax(100px, auto));
            gap: 4px;
        }
        /* Apply blur and transparency to themed-bg elements when custom background is active */
        body.custom-background-active .themed-bg {
            background-color: var(--bg-secondary-color-transparent);
            backdrop-filter: blur(var(--current-blur-amount));
            -webkit-backdrop-filter: blur(var(--current-blur-amount)); /* For Safari */
        }
        /* Apply blur and transparency to grid cells when custom background is active */
        body.custom-background-active .grid-cell {
            background-color: var(--bg-secondary-color-transparent);
            backdrop-filter: blur(var(--current-blur-amount));
            -webkit-backdrop-filter: blur(var(--current-blur-amount)); /* For Safari */
        }
        .grid-cell {
            transition: all 0.2s ease-in-out;
            position: relative;
            background-color: var(--bg-secondary-color); /* Default, overridden by .custom-background-active .themed-bg */
            align-content: start;
        }
        .grid-cell:hover .add-btn {
            opacity: 1;
        }
        .add-btn {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .task-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: var(--bg-secondary-color);
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
        }
        .modal-backdrop.active .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .completed-task {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .completed-task .status-dot {
            background-color: #4ade80;
        }
        .themed-bg { background-color: var(--bg-secondary-color); } /* Base themed background */
        .themed-bg-tertiary { background-color: var(--bg-tertiary-color); }
        .themed-text { color: var(--text-primary-color); }
        .themed-text-secondary { color: var(--text-secondary-color); }
        .themed-border { border-color: var(--border-color); }
        .themed-border-focus:focus { border-color: var(--border-focus-color); }

        /* Styles for link deletion mode */
        .deletable-link {
            cursor: pointer;
            border: 2px dashed #ef4444; /* red-500 */
            animation: pulse-faint 2s infinite;
        }

        @keyframes pulse-faint {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .day-header {
            cursor: pointer;
        }

        /* Message box styling */
        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none; /* Hidden by default */
            text-align: center;
            font-size: 18px;
        }
        #messageBox button {
            margin-top: 15px;
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        #messageBox button:hover {
            background-color: #6366f1; /* Indigo-500 */
        }
        /* Style for the blur slider container */
        .blur-slider-container {
            background-color: var(--bg-secondary-color); /* Default, overridden by custom-background-active */
            border: 1px solid var(--border-color); /* Add a border */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        body.custom-background-active .blur-slider-container {
            background-color: var(--bg-secondary-color-transparent);
            backdrop-filter: blur(var(--current-blur-amount));
            -webkit-backdrop-filter: blur(var(--current-blur-amount));
            border-color: rgba(75, 85, 99, 0.5); /* Semi-transparent border for glassy look */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Custom Message Box -->
    <div id="messageBox">
        <p id="messageText"></p>
        <button onclick="hideMessageBox()">OK</button>
    </div>

    <div class="max-w-7xl mx-auto">

        <header class="flex items-center justify-between mb-8 flex-wrap gap-4">
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold themed-text">My Week</h1>
                <span id="week-display" class="text-xl themed-text-secondary font-medium">Week 11</span>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
                   <button id="export-data-btn" class="px-4 py-2 text-sm rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold transition">Export Data</button>
                   <input type="file" id="import-data-input" class="hidden" accept=".json">
                   <button id="import-data-btn" class="px-4 py-2 text-sm rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition">Import Data</button>
                   
                   <!-- Hidden file input for background upload -->
                   <input type="file" id="background-upload-input" accept="image/*" class="hidden">
                   <!-- Button to trigger background upload options -->
                   <button id="upload-background-btn" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors" title="Upload Custom Background">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.44 11.02A10 10 0 0 0 12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.01 0 .01 0 .02 0h9.42c.87 0 1.58-.71 1.58-1.58V12c0-.55-.45-1-1-1zm-9.44 9V12m0-8v4m-4 0h8m-4 4v4m-4 0h8"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                   </button>

                   <button id="theme-toggle" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors">
                       <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                       <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                   </button>
                <button id="prev-week" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                <button id="next-week" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </button>
                <button id="reset-btn" class="px-4 py-2 text-sm rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition">Reset</button>
            </div>
        </header>

        <!-- Blur Intensity Slider -->
        <div class="flex items-center justify-end gap-2 mb-4 blur-slider-container rounded-lg py-2 px-4">
            <label for="blur-slider" class="themed-text-secondary text-sm">Blur Intensity:</label>
            <input type="range" id="blur-slider" min="0" max="20" value="0" class="w-24 accent-indigo-600 cursor-pointer" disabled>
        </div>

        <div id="quick-links-section" class="mb-8 themed-bg p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                   <h2 class="text-xl font-semibold themed-text">Quick Links</h2>
                   <div class="flex items-center gap-2">
                       <button id="toggle-delete-link-btn" class="px-4 py-2 text-sm rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold transition">Delete</button>
                       <button id="add-link-btn" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Add Link</button>
                       </div>
            </div>
            <div id="links-container" class="flex flex-wrap gap-3">
                </div>
        </div>

        <div id="timetable" class="timetable-grid themed-bg p-2 rounded-xl"></div>

        <div id="weekly-goal-section" class="mt-8 themed-bg p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold themed-text mb-4">Goal for the Week</h2>
            <textarea id="weekly-goal" class="w-full themed-bg-tertiary themed-text p-4 rounded-lg border-2 border-transparent themed-border-focus transition" placeholder="Define your main objective for this week..."></textarea>
        </div>
    </div>

    <div id="task-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 themed-text">Add New Task</h2>
            <form id="task-form">
                <input type="hidden" id="task-id"><input type="hidden" id="task-day"><input type="hidden" id="task-row">
                <div class="mb-4">
                    <label for="task-name" class="block text-sm font-medium themed-text-secondary mb-2">Task / Class Name</label>
                    <textarea id="task-name" class="w-full themed-bg-tertiary themed-text px-4 py-2 rounded-lg border-2 themed-border themed-border-focus transition" rows="4" required></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium themed-text-secondary mb-2">Color Tag</label>
                    <div id="color-picker" class="flex gap-3">
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-red-500" data-color="bg-red-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-blue-500" data-color="bg-blue-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-green-500" data-color="bg-green-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-yellow-500" data-color="bg-yellow-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-purple-500" data-color="bg-purple-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-pink-500" data-color="bg-pink-500"></div>
                    </div>
                    <input type="hidden" id="task-color" value="bg-blue-500">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="delete-task-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition hidden">Delete</button>
                    <button type="button" id="cancel-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Save Task</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="link-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 id="link-modal-title" class="text-2xl font-bold mb-6 themed-text">Add New Link</h2>
            <form id="link-form">
                <input type="hidden" id="link-id">
                <div class="mb-4">
                    <label for="link-name" class="block text-sm font-medium themed-text-secondary mb-2">Link Name</label>
                    <input type="text" id="link-name" class="w-full themed-bg-tertiary themed-text px-4 py-2 rounded-lg border-2 themed-border themed-border-focus transition" required>
                </div>
                <div class="mb-6">
                    <label for="link-url" class="block text-sm font-medium themed-text-secondary mb-2">URL</label>
                    <input type="url" id="link-url" class="w-full themed-bg-tertiary themed-text px-4 py-2 rounded-lg border-2 themed-border themed-border-focus transition" placeholder="https://example.com" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="delete-link-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition hidden">Delete</button>
                    <button type="button" id="cancel-link-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Save Link</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reset-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8 text-center">
            <h2 class="text-2xl font-bold mb-6 themed-text">Reset Timetable Data</h2>
            <p class="themed-text-secondary mb-8">Choose how you want to reset your timetable tasks. Quick links will not be affected.</p>
            <div class="flex flex-col gap-4">
                <button id="clear-current-week-btn" class="px-6 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition">Clear Current Week's Tasks</button>
                <button id="clear-all-weeks-btn" class="px-6 py-3 rounded-lg bg-red-800 hover:bg-red-900 text-white font-semibold transition">Clear All Weeks' Tasks</button>
                <button id="cancel-reset-btn" class="px-6 py-3 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Background Options Modal -->
    <div id="background-options-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8 text-center">
            <h2 class="text-2xl font-bold mb-6 themed-text">Background Options</h2>
            <p class="themed-text-secondary mb-8">What would you like to do with the background?</p>
            <div class="flex flex-col gap-4">
                <button id="revert-background-btn" class="px-6 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition">Revert to Default Background</button>
                <button id="upload-new-background-btn" class="px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Upload New Background</button>
                <button id="cancel-background-options-btn" class="px-6 py-3 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Function to show a custom message box instead of alert()
        function showMessageBox(message) {
            document.getElementById('messageText').innerText = message;
            document.getElementById('messageBox').style.display = 'block';
        }

        // Function to hide the custom message box
        function hideMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const timetable = document.getElementById('timetable');
            const taskModal = document.getElementById('task-modal');
            const linkModal = document.getElementById('link-modal');
            const resetModal = document.getElementById('reset-modal');
            const backgroundOptionsModal = document.getElementById('background-options-modal');
            const themeToggle = document.getElementById('theme-toggle');
            const toggleDeleteLinkBtn = document.getElementById('toggle-delete-link-btn');
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const importDataInput = document.getElementById('import-data-input');
            const backgroundUploadInput = document.getElementById('background-upload-input');
            const uploadBackgroundBtn = document.getElementById('upload-background-btn');
            const revertBackgroundBtn = document.getElementById('revert-background-btn');
            const uploadNewBackgroundBtn = document.getElementById('upload-new-background-btn');
            const cancelBackgroundOptionsBtn = document.getElementById('cancel-background-options-btn');
            
            // New elements for blur functionality
            const quickLinksSection = document.getElementById('quick-links-section');
            const weeklyGoalSection = document.getElementById('weekly-goal-section');
            const blurSlider = document.getElementById('blur-slider');
            const blurSliderContainer = document.querySelector('.blur-slider-container'); // Get the container

            // --- State Variables ---
            const days = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const rowLabels = ['Class', 'Prio 1', 'Prio 2', 'Prio 3', 'Prio 4', 'Done'];
            let currentWeek = 1;
            let tasks = {}; // { 'week-day-row': [{id, name, color, completed}, ...] }
            let links = []; // [{id, name, url}]
            let isLinkDeleteMode = false;
            let weekDates = {}; // { 'weekNumber': 'YYYY-MM-DD' (date of Saturday for that week) }

            // --- Date Formatting Helper ---
            const formatDate = (date) => {
                const options = { day: 'numeric', month: 'long' };
                const formattedDate = date.toLocaleDateString('en-US', options);
                const day = date.getDate();
                let suffix;
                if (day > 3 && day < 21) suffix = 'th';
                else {
                    switch (day % 10) {
                        case 1: suffix = 'st'; break;
                        case 2: suffix = 'nd'; break;
                        case 3: suffix = 'rd'; break;
                        default: suffix = 'th';
                    }
                }
                return `${day}${suffix} of ${date.toLocaleDateString('en-US', { month: 'long' })}`;
            };

            // --- State Management ---
            function loadState() {
                const savedTasks = localStorage.getItem('timetableTasks_v2');
                const savedLinks = localStorage.getItem('timetableLinks');
                const savedWeek = localStorage.getItem('timetableWeek');
                const savedGoal = localStorage.getItem('timetableGoal');
                const savedTheme = localStorage.getItem('timetableTheme');
                const savedWeekDates = localStorage.getItem('timetableWeekDates');
                const savedBackground = localStorage.getItem('customBackground');
                const savedBlurAmount = localStorage.getItem('blurAmount');

                if (savedTasks) tasks = JSON.parse(savedTasks);
                if (savedLinks) links = JSON.parse(savedLinks);
                if (savedWeek) currentWeek = parseInt(savedWeek, 10);
                if (savedGoal) document.getElementById('weekly-goal').value = savedGoal;
                if (savedTheme) document.body.classList.toggle('light-mode', savedTheme === 'light');
                if (savedWeekDates) weekDates = JSON.parse(savedWeekDates);
                
                // Apply saved background and blur
                if (savedBackground) {
                    document.body.style.backgroundImage = `url('${savedBackground}')`;
                    document.body.classList.add('custom-background-active'); // Add class to enable blur styles
                    blurSlider.disabled = false; // Enable slider
                    const blurValue = savedBlurAmount ? parseFloat(savedBlurAmount) : 5; // Default blur if not saved
                    blurSlider.value = blurValue;
                    document.body.style.setProperty('--current-blur-amount', `${blurValue}px`);
                } else {
                    document.body.style.backgroundImage = '';
                    document.body.classList.remove('custom-background-active'); // Remove class to disable blur styles
                    blurSlider.disabled = true; // Disable slider
                    blurSlider.value = 0;
                    document.body.style.setProperty('--current-blur-amount', `0px`);
                }

                // Initialize current week's date if not set
                if (!weekDates[currentWeek]) {
                    setWeekToCurrentDate(currentWeek);
                }
                updateThemeIcon();
            }

            function saveState() {
                localStorage.setItem('timetableTasks_v2', JSON.stringify(tasks));
                localStorage.setItem('timetableLinks', JSON.stringify(links));
                localStorage.setItem('timetableWeek', currentWeek);
                localStorage.setItem('timetableGoal', document.getElementById('weekly-goal').value);
                localStorage.setItem('timetableTheme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
                localStorage.setItem('timetableWeekDates', JSON.stringify(weekDates));
                
                const currentBackground = document.body.style.backgroundImage;
                if (currentBackground && currentBackground.startsWith('url("data:image/')) {
                    localStorage.setItem('customBackground', currentBackground.slice(5, -2)); // Remove url("")
                    localStorage.setItem('blurAmount', blurSlider.value); // Save blur amount
                } else {
                    localStorage.removeItem('customBackground');
                    localStorage.removeItem('blurAmount'); // Remove blur amount if no custom background
                }
            }
            
            // --- Date Calculation and Setting ---
            function getSaturdayDateForWeek(weekNum) {
                const dateStr = weekDates[weekNum];
                if (dateStr) {
                    return new Date(dateStr + 'T00:00:00'); // Add T00:00:00 to ensure consistent timezone interpretation
                }
                return null;
            }

            function setSaturdayDateForWeek(weekNum, saturdayDate) {
                weekDates[weekNum] = saturdayDate.toISOString().split('T')[0]; // Store as YYYY-MM-DD
                saveState();
            }

            function updateDatesFromReference(referenceDayIndex, referenceDate) {
                // Calculate Saturday's date for the current week based on the reference
                const saturdayDate = new Date(referenceDate);
                saturdayDate.setDate(referenceDate.getDate() - referenceDayIndex); // dayIndex: 0 for Saturday, 1 for Sunday, etc.
                
                setSaturdayDateForWeek(currentWeek, saturdayDate);
                
                // Recalculate dates for other weeks
                // Adjust the range if you need more weeks to be auto-updated
                for (let i = -52; i <= 52; i++) { // Recalculate for a range of +/- 1 year (approx 52 weeks)
                    if (i === 0) continue; // Skip current week as it's already set
                    const targetWeek = currentWeek + i;
                    const newSaturdayDate = new Date(saturdayDate);
                    newSaturdayDate.setDate(saturdayDate.getDate() + (i * 7));
                    setSaturdayDateForWeek(targetWeek, newSaturdayDate);
                }
                renderTimetable();
            }

            function setWeekToCurrentDate(weekNum) {
                const today = new Date();
                const todayDayIndex = (today.getDay() + 6) % 7; // Convert to 0=Sat, 1=Sun...
                
                const saturdayDate = new Date(today);
                saturdayDate.setDate(today.getDate() - todayDayIndex);
                setSaturdayDateForWeek(weekNum, saturdayDate);
            }

            // --- UI Rendering ---
            function renderTimetable() {
                timetable.innerHTML = '';
                document.getElementById('week-display').textContent = `Week ${currentWeek}`;

                // Header row (empty cell, then days)
                timetable.appendChild(document.createElement('div'));

                const currentWeekSaturday = getSaturdayDateForWeek(currentWeek);
                const tempDate = currentWeekSaturday ? new Date(currentWeekSaturday) : null;

                days.forEach((dayName, dayIndex) => {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'text-center font-semibold themed-text-secondary py-3 day-header';
                    headerCell.dataset.dayIndex = dayIndex; // Store day index for event listener

                    const daySpan = document.createElement('span');
                    daySpan.textContent = dayName;
                    headerCell.appendChild(daySpan);

                    if (tempDate) {
                        const dateForDay = new Date(tempDate);
                        dateForDay.setDate(tempDate.getDate() + dayIndex); // Add days from Saturday
                        const dateDisplay = document.createElement('div');
                        dateDisplay.className = 'text-xs font-normal themed-text-secondary mt-1';
                        dateDisplay.textContent = formatDate(dateForDay);
                        headerCell.appendChild(dateDisplay);
                    }
                    
                    headerCell.addEventListener('click', () => {
                        let newDate;
                        let validDate = false;
                        while(!validDate) {
                            newDate = prompt(`Set date for ${dayName} (DD/MM). E.g., 02/07`);
                            if (newDate === null) { // User cancelled
                                return;
                            }
                            const [day, month] = newDate.split('/').map(Number);
                            // Basic validation for DD/MM format and valid numbers
                            if (day && month && !isNaN(day) && !isNaN(month) && day >= 1 && day <= 31 && month >= 1 && month <= 12) {
                                validDate = true;
                                const year = (new Date()).getFullYear(); // Assume current year for input
                                const setDate = new Date(year, month - 1, day);
                                updateDatesFromReference(dayIndex, setDate);
                            } else {
                                showMessageBox('Invalid date format or values. Please use DD/MM (e.g., 02/07) with valid day/month numbers.');
                            }
                        }
                    });
                    timetable.appendChild(headerCell);
                });

                for (let i = 0; i < 6; i++) {
                    const labelCell = document.createElement('div');
                    labelCell.className = 'text-center text-sm font-medium themed-text-secondary flex items-center justify-center';
                    labelCell.textContent = rowLabels[i];
                    timetable.appendChild(labelCell);

                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('div');
                        // Add 'themed-bg' to grid-cell so it picks up the blur styles
                        cell.className = 'grid-cell rounded-lg min-h-[100px] p-2 flex flex-col items-center gap-1 themed-bg'; 
                        cell.dataset.day = j;
                        cell.dataset.row = i;
                        
                        const taskKey = `${currentWeek}-${j}-${i}`;
                        if (tasks[taskKey] && tasks[taskKey].length > 0) {
                            tasks[taskKey].forEach(task => cell.appendChild(createTaskCard(task)));
                        }
                        
                        const addButton = document.createElement('button');
                        addButton.className = 'add-btn mt-auto p-2 rounded-full themed-bg-tertiary hover:bg-indigo-600 text-white transition-all';
                        addButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
                        addButton.onclick = () => openTaskModal(j, i);
                        cell.appendChild(addButton);
                        timetable.appendChild(cell);
                    }
                }
            }
            
            function createTaskCard(task) {
                const card = document.createElement('div');
                card.className = `task-card p-2 mb-1 rounded-md text-white shadow-md w-full flex flex-col justify-between ${task.color}`;
                if (task.completed) card.classList.add('completed-task');
                card.dataset.taskId = task.id;
                
                const taskName = document.createElement('p');
                taskName.className = 'font-semibold text-sm break-words whitespace-pre-wrap';
                taskName.textContent = task.name;

                const cardFooter = document.createElement('div');
                cardFooter.className = 'flex items-center justify-between mt-2';
                
                const statusDot = document.createElement('div');
                statusDot.className = 'status-dot w-3 h-3 rounded-full';
                statusDot.style.backgroundColor = task.completed ? '#4ade80' : '#f87171';

                const completeToggle = document.createElement('input');
                completeToggle.type = 'checkbox';
                completeToggle.checked = task.completed;
                completeToggle.className = "w-4 h-4 rounded text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-600 focus:ring-2";
                completeToggle.onclick = (e) => { e.stopPropagation(); toggleTaskCompletion(task.id); };

                cardFooter.appendChild(statusDot);
                cardFooter.appendChild(completeToggle);
                card.appendChild(taskName);
                card.appendChild(cardFooter);
                card.onclick = () => openTaskModal(task.day, task.row, task);
                return card;
            }

            function renderLinks() {
                const container = document.getElementById('links-container');
                container.innerHTML = '';
                if (links.length === 0 && !isLinkDeleteMode) {
                    container.innerHTML = `<p class="themed-text-secondary text-sm">No links added yet. Click 'Add Link' to get started.</p>`;
                } else if (links.length === 0 && isLinkDeleteMode) {
                       container.innerHTML = `<p class="themed-text-secondary text-sm">No links to delete.</p>`;
                }

                links.forEach(link => {
                    const linkEl = document.createElement('a');
                    linkEl.href = link.url;
                    linkEl.target = '_blank';
                    linkEl.rel = 'noopener noreferrer';
                    linkEl.className = 'px-4 py-2 rounded-lg themed-bg-tertiary themed-text font-semibold transition hover:opacity-80';
                    linkEl.textContent = link.name;
                    
                    if (isLinkDeleteMode) {
                        linkEl.classList.add('deletable-link');
                        linkEl.onclick = (e) => {
                            e.preventDefault();
                            deleteLink(link.id);
                        };
                    } else {
                        linkEl.onclick = (e) => {
                            if (e.ctrlKey || e.metaKey) {
                                e.preventDefault();
                                openLinkModal(link);
                            }
                        };
                    }
                    container.appendChild(linkEl);
                });
            }

            // --- Modal Logic ---
            function openTaskModal(day, row, task = null) {
                openModal(taskModal);
                const form = document.getElementById('task-form');
                form.reset();
                document.getElementById('delete-task-btn').classList.toggle('hidden', !task);
                document.getElementById('modal-title').textContent = task ? 'Edit Task' : 'Add New Task';
                
                document.getElementById('task-day').value = day;
                document.getElementById('task-row').value = row;
                
                document.querySelectorAll('.color-option').forEach(el => el.style.border = '2px solid transparent');
                const colorInput = document.getElementById('task-color');
                
                if (task) {
                    document.getElementById('task-id').value = task.id;
                    document.getElementById('task-name').value = task.name;
                    colorInput.value = task.color;
                } else {
                    document.getElementById('task-id').value = '';
                    colorInput.value = 'bg-blue-500';
                }
                const selectedColorEl = document.querySelector(`.color-option[data-color="${colorInput.value}"]`);
                if (selectedColorEl) selectedColorEl.style.border = '2px solid white';
            }

            function openLinkModal(link = null) {
                openModal(linkModal);
                const form = document.getElementById('link-form');
                form.reset();
                document.getElementById('delete-link-btn').classList.toggle('hidden', !link);
                document.getElementById('link-modal-title').textContent = link ? 'Edit Link' : 'Add New Link';

                if (link) {
                    document.getElementById('link-id').value = link.id;
                    document.getElementById('link-name').value = link.name;
                    document.getElementById('link-url').value = link.url;
                } else {
                    document.getElementById('link-id').value = '';
                }
            }

            function openModal(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => modal.classList.add('active'), 10);
            }

            function closeModal(modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 300);
            }

            // --- Event Handlers & Logic ---
            document.getElementById('task-form').addEventListener('submit', handleTaskFormSubmit);
            document.getElementById('link-form').addEventListener('submit', handleLinkFormSubmit);

            function handleTaskFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('task-id').value;
                const name = document.getElementById('task-name').value;
                const color = document.getElementById('task-color').value;
                const day = document.getElementById('task-day').value;
                const row = document.getElementById('task-row').value;
                const taskKey = `${currentWeek}-${day}-${row}`;

                if (!tasks[taskKey]) tasks[taskKey] = [];
                
                const taskIndex = tasks[taskKey].findIndex(t => t.id === id);

                if (taskIndex > -1) { // Editing
                    tasks[taskKey][taskIndex] = { ...tasks[taskKey][taskIndex], name, color };
                } else { // Adding
                    tasks[taskKey].push({ id: `task-${Date.now()}`, name, color, day, row, completed: false });
                }
                
                closeModal(taskModal);
                renderTimetable();
                saveState();
            }

            function handleLinkFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('link-id').value;
                const name = document.getElementById('link-name').value;
                let url = document.getElementById('link-url').value;

                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }

                const linkIndex = links.findIndex(l => l.id === id);

                if (linkIndex > -1) { // Editing
                    links[linkIndex] = { id, name, url };
                } else { // Adding
                    links.push({ id: `link-${Date.now()}`, name, url });
                }

                closeModal(linkModal);
                renderLinks();
                saveState();
            }
            
            document.getElementById('delete-task-btn').onclick = () => {
                const id = document.getElementById('task-id').value;
                Object.keys(tasks).forEach(key => {
                    tasks[key] = tasks[key].filter(t => t.id !== id);
                });
                closeModal(taskModal);
                renderTimetable();
                saveState();
            };
            
            document.getElementById('delete-link-btn').onclick = () => {
                const id = document.getElementById('link-id').value;
                links = links.filter(l => l.id !== id);
                closeModal(linkModal);
                renderLinks();
                saveState();
            };

            function deleteLink(id) {
                links = links.filter(l => l.id !== id);
                renderLinks();
                saveState();
            }

            toggleDeleteLinkBtn.addEventListener('click', () => {
                isLinkDeleteMode = !isLinkDeleteMode;
                toggleDeleteLinkBtn.textContent = isLinkDeleteMode ? 'Done' : 'Delete';
                toggleDeleteLinkBtn.classList.toggle('bg-red-600', isLinkDeleteMode);
                toggleDeleteLinkBtn.classList.toggle('hover:bg-red-700', isLinkDeleteMode);
                toggleDeleteLinkBtn.classList.toggle('bg-gray-600', !isLinkDeleteMode);
                toggleDeleteLinkBtn.classList.toggle('hover:bg-gray-700', !isLinkDeleteMode);
                renderLinks();
            });

            document.getElementById('cancel-btn').onclick = () => closeModal(taskModal);
            document.getElementById('cancel-link-btn').onclick = () => closeModal(linkModal);
            document.getElementById('add-link-btn').onclick = () => openLinkModal();

            document.getElementById('color-picker').addEventListener('click', (e) => {
                if (e.target.classList.contains('color-option')) {
                    document.querySelectorAll('.color-option').forEach(el => el.style.border = '2px solid transparent');
                    e.target.style.border = '2px solid white';
                    document.getElementById('task-color').value = e.target.dataset.color;
                }
            });
            
            function toggleTaskCompletion(taskId) {
                for (const key in tasks) {
                    const task = tasks[key].find(t => t.id === taskId);
                    if (task) {
                        task.completed = !task.completed;
                        break;
                    }
                }
                renderTimetable();
                saveState();
            }

            // --- Theme Toggle ---
            themeToggle.onclick = () => {
                document.body.classList.toggle('light-mode');
                updateThemeIcon();
                saveState();
            };

            function updateThemeIcon() {
                const isLight = document.body.classList.contains('light-mode');
                document.getElementById('theme-icon-sun').classList.toggle('hidden', !isLight);
                document.getElementById('theme-icon-moon').classList.toggle('hidden', isLight);
            }

            // --- Week Navigation & Goal Saving ---
            document.getElementById('prev-week').onclick = () => { 
                currentWeek--; 
                if (!weekDates[currentWeek]) {
                    const prevSaturday = new Date(getSaturdayDateForWeek(currentWeek + 1));
                    prevSaturday.setDate(prevSaturday.getDate() - 7);
                    setSaturdayDateForWeek(currentWeek, prevSaturday);
                }
                renderTimetable(); 
                saveState(); 
            };
            document.getElementById('next-week').onclick = () => { 
                currentWeek++; 
                if (!weekDates[currentWeek]) {
                    const nextSaturday = new Date(getSaturdayDateForWeek(currentWeek - 1));
                    nextSaturday.setDate(nextSaturday.getDate() + 7);
                    setSaturdayDateForWeek(currentWeek, nextSaturday);
                }
                renderTimetable(); 
                saveState(); 
            };
            document.getElementById('weekly-goal').addEventListener('input', saveState);

            // --- Reset Functionality ---
            document.getElementById('reset-btn').onclick = () => openModal(resetModal);
            document.getElementById('cancel-reset-btn').onclick = () => closeModal(resetModal);

            document.getElementById('clear-current-week-btn').onclick = () => {
                const currentWeekKeys = Object.keys(tasks).filter(key => key.startsWith(`${currentWeek}-`));
                currentWeekKeys.forEach(key => delete tasks[key]);
                document.getElementById('weekly-goal').value = ''; // Clear goal for current week
                closeModal(resetModal);
                renderTimetable();
                saveState();
            };

            document.getElementById('clear-all-weeks-btn').onclick = () => {
                showMessageBox("Are you sure you want to clear ALL tasks from ALL weeks and ALL saved week dates? This cannot be undone unless you have exported your data. Click OK to proceed.");
                document.getElementById('messageBox').querySelector('button').onclick = () => {
                    hideMessageBox();
                    tasks = {}; // Clear all tasks
                    weekDates = {}; // Clear all saved dates
                    document.getElementById('weekly-goal').value = ''; // Clear goal for current week
                    setWeekToCurrentDate(currentWeek); // Reset current week's date to today
                    closeModal(resetModal);
                    renderTimetable();
                    saveState();
                };
            };

            // --- Export/Import Functionality ---
            exportDataBtn.addEventListener('click', () => {
                const dataToExport = {
                    tasks: tasks,
                    weekDates: weekDates,
                    links: links, // Include quick links in export
                    currentWeek: currentWeek, // Also export current week
                    weeklyGoal: document.getElementById('weekly-goal').value, // Also export current week's goal
                    customBackground: localStorage.getItem('customBackground'), // Include custom background
                    blurAmount: localStorage.getItem('blurAmount') // Include blur amount
                };
                const jsonString = JSON.stringify(dataToExport, null, 2); // Pretty print JSON

                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `timetable_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            importDataBtn.addEventListener('click', () => {
                backgroundUploadInput.value = null; // Clear any previously selected file
                importDataInput.click(); // Programmatically click the hidden file input
            });

            importDataInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                showMessageBox("Importing data will OVERWRITE your current timetable tasks, links, and dates. Are you sure you want to proceed? Click OK to confirm.");
                document.getElementById('messageBox').querySelector('button').onclick = () => {
                    hideMessageBox();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            // Overwrite global state with imported data
                            tasks = importedData.tasks || {};
                            weekDates = importedData.weekDates || {};
                            links = importedData.links || [];
                            currentWeek = importedData.currentWeek !== undefined ? importedData.currentWeek : 1;
                            document.getElementById('weekly-goal').value = importedData.weeklyGoal || '';
                            
                            // Apply imported custom background and blur
                            if (importedData.customBackground) {
                                document.body.style.backgroundImage = `url('${importedData.customBackground}')`;
                                localStorage.setItem('customBackground', importedData.customBackground);
                                document.body.classList.add('custom-background-active');
                                blurSlider.disabled = false;
                                const blurValue = importedData.blurAmount ? parseFloat(importedData.blurAmount) : 5;
                                blurSlider.value = blurValue;
                                document.body.style.setProperty('--current-blur-amount', `${blurValue}px`);
                                localStorage.setItem('blurAmount', blurValue);
                            } else {
                                document.body.style.backgroundImage = '';
                                localStorage.removeItem('customBackground');
                                document.body.classList.remove('custom-background-active');
                                blurSlider.disabled = true;
                                blurSlider.value = 0;
                                document.body.style.setProperty('--current-blur-amount', `0px`);
                                localStorage.removeItem('blurAmount');
                            }

                            saveState(); // Save imported data to local storage
                            renderTimetable(); // Re-render the UI with new data
                            renderLinks(); // Re-render quick links
                            showMessageBox('Data imported successfully!');

                        } catch (error) {
                            showMessageBox('Error importing data. Please ensure it is a valid JSON file. Error: ' + error.message);
                            console.error('Error parsing imported JSON:', error);
                        } finally {
                            event.target.value = null; // Clear the selected file to allow re-selection
                        }
                    };
                    reader.onerror = () => {
                        showMessageBox('Failed to read file.');
                        event.target.value = null; // Clear the selected file
                    };
                    reader.readAsText(file);
                };
            });

            // --- Background Options and Upload Functionality ---
            uploadBackgroundBtn.addEventListener('click', () => {
                openModal(backgroundOptionsModal); // Open the new options modal
            });

            revertBackgroundBtn.addEventListener('click', () => {
                document.body.style.backgroundImage = ''; // Remove custom background
                localStorage.removeItem('customBackground'); // Clear from local storage
                document.body.classList.remove('custom-background-active'); // Remove class
                blurSlider.disabled = true; // Disable slider
                blurSlider.value = 0; // Reset slider
                document.body.style.setProperty('--current-blur-amount', `0px`); // Reset blur CSS variable
                localStorage.removeItem('blurAmount'); // Remove blur amount from local storage
                saveState(); // Save the state
                closeModal(backgroundOptionsModal); // Close the modal
                showMessageBox('Background reverted to default!');
            });

            uploadNewBackgroundBtn.addEventListener('click', () => {
                backgroundUploadInput.click(); // Trigger the file input
                closeModal(backgroundOptionsModal); // Close the modal
            });

            cancelBackgroundOptionsBtn.addEventListener('click', () => {
                closeModal(backgroundOptionsModal); // Close the modal
            });

            backgroundUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.body.style.backgroundImage = `url('${e.target.result}')`;
                        document.body.classList.add('custom-background-active'); // Add class to enable blur
                        blurSlider.disabled = false; // Enable slider
                        // Set a default blur if none was previously set, or keep existing
                        const currentBlur = localStorage.getItem('blurAmount') || '5';
                        blurSlider.value = currentBlur;
                        document.body.style.setProperty('--current-blur-amount', `${currentBlur}px`);
                        saveState();
                        showMessageBox('Background uploaded successfully!');
                    };
                    reader.onerror = () => {
                        showMessageBox('Error loading background image.');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // --- Blur Slider Event Listener ---
            blurSlider.addEventListener('input', () => {
                const blurValue = blurSlider.value;
                document.body.style.setProperty('--current-blur-amount', `${blurValue}px`);
                saveState(); // Save the new blur amount
            });

            // --- Initial Load ---
            loadState();
            renderTimetable();
            renderLinks();
        });
    </script>
</body>
</html>
