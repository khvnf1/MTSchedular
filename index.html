<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Timetable Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Favicon / Icon for the website (for browser tab/window) -->
    <link rel="icon" href="MTS.png" type="image/png">
    <link rel="icon" href="MTS.ico" type="image/x-icon">
    <style>
        :root {
            --bg-color: #111827;
            --bg-secondary-color: #1f2937;
            --bg-tertiary-color: #374151;
            --text-primary-color: #f3f4f6;
            --text-secondary-color: #d1d5db;
            --border-color: #4b5563;
            --border-focus-color: #6366f1;
            /* New CSS variables for transparent colors and blur amount */
            --bg-secondary-color-transparent: rgba(31, 41, 55, 0.7);
            --current-blur-amount: 0px; /* Default no blur */
            /* New distinct color for upcoming tasks section */
            --upcoming-tasks-bg: #2d3748; /* Darker gray-800 equivalent */
            --upcoming-tasks-bg-transparent: rgba(45, 55, 72, 0.7);
        }

        body.light-mode {
            --bg-color: #f9fafb;
            --bg-secondary-color: #ffffff;
            --bg-tertiary-color: #e5e7eb;
            --text-primary-color: #111827;
            --text-secondary-color: #4b5563;
            --border-color: #d1d5db;
            --border-focus-color: #4f46e5;
            /* Transparent colors for light mode */
            --bg-secondary-color-transparent: rgba(255, 255, 255, 0.7);
            --upcoming-tasks-bg: #cbd5e0; /* Light gray-300 equivalent */
            --upcoming-tasks-bg-transparent: rgba(203, 213, 224, 0.7);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary-color);
            transition: background-color 0.3s ease, color 0.3s ease, background-image 0.5s ease-in-out; /* Added background-image transition */
            background-size: cover; /* Ensure background image covers the whole body */
            background-position: center; /* Center the background image */
            background-repeat: no-repeat; /* Do not repeat the background image */
            background-attachment: fixed; /* Keep background fixed when scrolling */
        }
        .timetable-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            grid-template-rows: auto repeat(6, minmax(100px, auto));
            gap: 4px;
        }
        /* Apply blur and transparency to themed-bg elements when custom background is active */
        body.custom-background-active .themed-bg {
            background-color: var(--bg-secondary-color-transparent);
            backdrop-filter: blur(var(--current-blur-amount));
            -webkit-backdrop-filter: blur(var(--current-blur-amount)); /* For Safari */
        }
        /* Apply blur and transparency to grid cells when custom background is active */
        body.custom-background-active .grid-cell {
            background-color: var(--bg-secondary-color-transparent);
            backdrop-filter: blur(var(--current-blur-amount));
            -webkit-backdrop-filter: blur(var(--current-blur-amount)); /* For Safari */
        }
        /* Apply blur and transparency to the new upcoming tasks section */
        body.custom-background-active .upcoming-tasks-section {
            background-color: var(--upcoming-tasks-bg-transparent);
            backdrop-filter: blur(var(--current-blur-amount));
            -webkit-backdrop-filter: blur(var(--current-blur-amount));
        }

        .grid-cell {
            transition: all 0.2s ease-in-out;
            position: relative;
            background-color: var(--bg-secondary-color); /* Default, overridden by .custom-background-active .themed-bg */
            align-content: start;
        }
        .grid-cell:hover .add-btn {
            opacity: 1;
        }
        .add-btn {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .task-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: var(--bg-secondary-color);
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
        }
        .modal-backdrop.active .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .completed-task {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .completed-task .status-dot {
            background-color: #4ade80;
        }
        .themed-bg { background-color: var(--bg-secondary-color); } /* Base themed background */
        .themed-bg-tertiary { background-color: var(--bg-tertiary-color); }
        .themed-text { color: var(--text-primary-color); }
        .themed-text-secondary { color: var(--text-secondary-color); }
        .themed-border { border-color: var(--border-color); }
        .themed-border-focus:focus { border-color: var(--border-focus-color); }

        /* Styles for link deletion mode */
        .deletable-link {
            cursor: pointer;
            border: 2px dashed #ef4444; /* red-500 */
            animation: pulse-faint 2s infinite;
        }

        @keyframes pulse-faint {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .day-header {
            cursor: pointer;
        }

        /* Message box styling */
        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none; /* Hidden by default */
            text-align: center;
            font-size: 18px;
        }
        #messageBox button {
            margin-top: 15px;
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        #messageBox button:hover {
            background-color: #6366f1; /* Indigo-500 */
        }
        /* Style for the blur slider container */
        .blur-slider-container {
            background-color: var(--bg-secondary-color); /* Default, overridden by custom-background-active */
            border: 1px solid var(--border-color); /* Add a border */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        body.custom-background-active .blur-slider-container {
            background-color: var(--bg-secondary-color-transparent);
            backdrop-filter: blur(var(--current-blur-amount));
            -webkit-backdrop-filter: blur(var(--current-blur-amount));
            border-color: rgba(75, 85, 99, 0.5); /* Semi-transparent border for glassy look */
        }

        /* --- Animation Level Adjustments --- */
        /* Reduced Animations */
        body.animation-reduced .grid-cell,
        body.animation-reduced .add-btn,
        body.animation-reduced .task-card,
        body.animation-reduced .modal-backdrop,
        body.animation-reduced .modal-content,
        body.animation-reduced button,
        body.animation-reduced #sidebar,
        body.animation-reduced #upcoming-tasks-content,
        body.animation-reduced #info-box {
            transition-duration: 0.15s !important; /* Shorter duration */
        }
        body.animation-reduced .task-card:hover {
            transform: translateY(-1px); /* Less dramatic hover */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); /* Less intense shadow */
        }
        body.animation-reduced .deletable-link {
            animation-duration: 4s !important; /* Slower pulse */
        }
        body.animation-reduced .modal-content {
             /* Keep transform and opacity transitions but shorter duration */
        }

        /* No Animations */
        body.animation-none .grid-cell,
        body.animation-none .add-btn,
        body.animation-none .task-card,
        body.animation-none .modal-backdrop,
        body.animation-none .modal-content,
        body.animation-none button,
        body.animation-none #theme-toggle,
        body.animation-none #prev-week,
        body.animation-none #next-week,
        body.animation-none #reset-btn,
        body.animation-none #export-data-btn,
        body.animation-none #import-data-btn,
        body.animation-none #upload-background-btn,
        body.animation-none #toggle-delete-link-btn,
        body.animation-none #add-link-btn,
        body.animation-none #revert-background-btn,
        body.animation-none #upload-new-background-btn,
        body.animation-none #cancel-background-options-btn,
        body.animation-none #clear-current-week-btn,
        body.animation-none #clear-all-weeks-btn,
        body.animation-none #cancel-reset-btn,
        body.animation-none #sidebar,
        body.animation-none #upcoming-tasks-content,
        body.animation-none #info-box {
            transition: none !important; /* Remove all transitions */
        }
        body.animation-none .task-card:hover {
            transform: none !important; /* Remove hover transform */
            box-shadow: none !important; /* Remove hover shadow */
        }
        body.animation-none .modal-content {
            transform: none !important; /* No initial transform */
            opacity: 1 !important; /* Always visible if active */
        }
        body.animation-none .deletable-link {
            animation: none !important; /* Remove animation */
            border: 2px dashed #ef4444; /* Keep static border */
        }
        body.animation-none {
            transition: none !important; /* Remove body background/color transitions */
        }

        /* Course Card Specific Styles */
        .course-card {
            min-width: 120px; /* Ensure cards have a minimum width */
            justify-content: center; /* Center text */
            text-align: center;
            font-weight: 500;
            position: relative;
            overflow: hidden; /* Hide overflow for potential long names */
            white-space: nowrap; /* Prevent wrapping */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            padding: 8px 12px; /* Adjust padding */
            border: 2px solid transparent; /* Default transparent border */
            transition: all 0.2s ease-in-out; /* Smooth transition for active state */
        }

        .course-card.active {
            border-color: #6366f1; /* Indigo-500 border for active course */
            box-shadow: 0 0 0 3px #6366f1, 0 4px 10px rgba(0,0,0,0.3); /* Glow effect */
            transform: scale(1.02); /* Slightly larger */
        }

        /* Styles for course deletion mode */
        .deletable-course {
            cursor: pointer;
            border: 2px dashed #ef4444; /* red-500 */
            animation: pulse-faint 2s infinite;
        }

        /* Sidebar specific styles */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 300px; /* Adjust as needed */
            background-color: var(--bg-secondary-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            z-index: 50; /* Below modals but above main content */
            padding: 1rem;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #sidebar.open {
            transform: translateX(0);
        }
        #sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 60; /* Above sidebar */
        }
        .sidebar-content-wrapper {
            overflow-y: auto; /* Enable scrolling for sidebar content */
            flex-grow: 1;
        }
        .upcoming-tasks-section {
            background-color: var(--upcoming-tasks-bg);
            border-radius: 0.5rem;
            padding: 1rem;
            transition: background-color 0.3s ease;
        }
        .upcoming-tasks-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .upcoming-tasks-content.open {
            max-height: 500px; /* Adjust based on content height */
        }
        .current-day-checkbox {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: inline-block;
            vertical-align: middle;
            margin-left: 4px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .current-day-checkbox.checked {
            background-color: #4ade80; /* Green-400 */
            border-color: #4ade80;
        }

        /* Info box styling */
        #info-box {
            margin-top: 1rem;
            margin-bottom: 1rem;
            background-color: var(--bg-secondary-color);
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 10;
            width: fit-content; /* Make it fit content, not full width */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            text-align: left; /* Align text to the left */
            margin-left: 0; /* Align to the left */
            margin-right: auto; /* Push to the left */
            cursor: pointer; /* Now clickable to open modal */
        }
        body.custom-background-active #info-box {
            background-color: var(--bg-secondary-color-transparent);
            backdrop-filter: blur(var(--current-blur-amount));
            -webkit-backdrop-filter: blur(var(--current-blur-amount));
        }
        #info-box-content { /* Renamed from info-box-summary for clarity */
            font-size: 0.875rem; /* text-sm */
            color: var(--text-secondary-color);
        }
        /* Style for individual upcoming task items in the modal */
        .upcoming-task-item-modal {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .upcoming-task-item-modal:hover {
            opacity: 0.9;
        }
        .upcoming-task-item-modal .task-name {
            font-weight: 600;
            color: var(--text-primary-color);
        }
        .upcoming-task-item-modal .task-due {
            font-size: 0.75rem;
            color: var(--text-secondary-color);
        }
        .upcoming-task-item-modal .delete-btn-modal {
            background-color: rgba(239, 68, 68, 0.8); /* red-500 with transparency */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            transition: background-color 0.2s ease;
        }
        .upcoming-task-item-modal .delete-btn-modal:hover {
            background-color: #ef4444; /* red-500 solid */
        }

        /* New styles for class details in task card */
        .task-card .class-details {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 0.25rem;
        }
        /* Styles for class items in the select-class modal */
        .select-class-item {
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .select-class-item:hover {
            opacity: 0.9;
        }
        .select-class-item .class-name {
            font-weight: 600;
            color: var(--text-primary-color);
        }
        .select-class-item .class-details-text {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Custom Message Box -->
    <div id="messageBox">
        <p id="messageText"></p>
        <button onclick="hideMessageBox()">OK</button>
    </div>

    <!-- Sidebar Toggle Button -->
    <button id="sidebar-toggle" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <!-- Sidebar -->
    <div id="sidebar">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold themed-text">Menu</h2>
            <button id="close-sidebar-btn" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="sidebar-content-wrapper">
            <!-- Upcoming Tasks Section (for adding and full list) -->
            <div class="upcoming-tasks-section p-4 rounded-lg shadow-md mb-4">
                <div class="flex justify-between items-center mb-4 cursor-pointer" id="toggle-upcoming-tasks">
                    <h3 class="text-lg font-semibold themed-text">Upcoming Tasks</h3>
                    <svg id="upcoming-tasks-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300 transform rotate-0">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
                <div id="upcoming-tasks-content" class="upcoming-tasks-content">
                    <div class="mb-4">
                        <label for="upcoming-task-name" class="block text-sm font-medium themed-text-secondary mb-2">Task Name</label>
                        <textarea id="upcoming-task-name" class="w-full themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition resize-y" rows="3" placeholder="e.g., Submit Assignment 3"></textarea>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <div class="flex-1">
                            <label for="upcoming-task-target-week" class="block text-sm font-medium themed-text-secondary mb-2">Target Week</label>
                            <input type="number" id="upcoming-task-target-week" class="w-full themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition" value="1">
                        </div>
                        <div class="flex-1">
                            <label for="upcoming-task-target-day" class="block text-sm font-medium themed-text-secondary mb-2">Target Day</label>
                            <select id="upcoming-task-target-day" class="w-full themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition">
                                <option value="0">Saturday</option>
                                <option value="1">Sunday</option>
                                <option value="2">Monday</option>
                                <option value="3">Tuesday</option>
                                <option value="4">Wednesday</option>
                                <option value="5">Thursday</option>
                                <option value="6">Friday</option>
                            </select>
                        </div>
                    </div>
                    <button id="save-upcoming-task-btn" class="w-full px-4 py-2 text-sm rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Save Upcoming Task</button>
                    <div id="upcoming-tasks-list" class="mt-4 border-t border-gray-600 pt-4">
                        <!-- Upcoming tasks will be listed here -->
                        <p class="themed-text-secondary text-sm">No upcoming tasks added.</p>
                    </div>
                </div>
            </div>
            <!-- Other sidebar content can go here -->
        </div>
    </div>

    <div class="max-w-7xl mx-auto">

        <header class="flex items-center justify-between mb-8 flex-wrap gap-4 relative">
            <div class="flex items-center gap-4">
                <!-- Icon added here -->
                <img id="header-icon" src="MTS.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/111827/f3f4f6?text=MTS';" alt="MTS Icon" class="w-8 h-8 mr-2">
                <h1 class="text-3xl font-bold themed-text">My Week</h1>
                <span id="week-display" class="text-xl themed-text-secondary font-medium">Week 11</span>
            </div>

            <div class="flex items-center gap-2 flex-wrap">
                   <button id="export-data-btn" class="px-4 py-2 text-sm rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold transition">Export Data</button>
                   <input type="file" id="import-data-input" class="hidden" accept=".json">
                   <button id="import-data-btn" class="px-4 py-2 text-sm rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition">Import Data</button>
                   
                   <!-- Hidden file input for background upload -->
                   <input type="file" id="background-upload-input" accept="image/*" class="hidden">
                   <!-- Button to trigger background upload options -->
                   <button id="upload-background-btn" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors" title="Upload Custom Background">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.44 11.02A10 10 0 0 0 12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.01 0 .01 0 .02 0h9.42c.87 0 1.58-.71 1.58-1.58V12c0-.55-.45-1-1-1zm-9.44 9V12m0-8v4m-4 0h8m-4 4v4m-4 0h8"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                   </button>

                   <button id="theme-toggle" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors">
                       <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                       <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                   </button>
                <button id="prev-week" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                <button id="next-week" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </button>
                <button id="reset-btn" class="px-4 py-2 text-sm rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition">Reset</button>
                <!-- New Animation Settings Button -->
                <button id="animation-settings-btn" class="p-2 rounded-md themed-bg-tertiary hover:bg-gray-600 transition-colors" title="Animation Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 6 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 2-2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 4.6 6a1.65 1.65 0 0 0 .33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9.09A1.65 1.65 0 0 0 10 3V3a2 2 0 0 1 2-1 2 2 0 0 1 2 1v.09a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1 .51l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0 .33 1.82V15z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Blur Intensity Slider -->
        <div class="flex items-center justify-end gap-2 mb-4 blur-slider-container">
            <label for="blur-slider" class="themed-text-secondary text-sm">Blur Intensity:</label>
            <input type="range" id="blur-slider" min="0" max="20" value="0" class="w-24 accent-indigo-600 cursor-pointer" disabled>
        </div>

        <div id="quick-links-section" class="mb-8 themed-bg p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                   <h2 class="text-xl font-semibold themed-text">Quick Links</h2>
                   <div class="flex items-center gap-2">
                       <button id="toggle-delete-link-btn" class="px-4 py-2 text-sm rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold transition">Delete</button>
                       <button id="add-link-btn" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Add Link</button>
                       </div>
            </div>
            <div id="links-container" class="flex flex-wrap gap-3">
                </div>
        </div>

        <!-- New Courses Section -->
        <div id="courses-section" class="mb-8 themed-bg p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold themed-text">My Courses</h2>
                <div class="flex items-center gap-2">
                    <button id="toggle-delete-course-btn" class="px-4 py-2 text-sm rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold transition">Delete</button>
                    <button id="clear-course-selection-btn" class="px-4 py-2 text-sm rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition hidden">Clear Selection</button>
                    <button id="add-course-btn" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Add Course</button>
                </div>
            </div>
            <div id="courses-container" class="flex flex-wrap gap-3">
                <!-- Course cards will be rendered here -->
            </div>
        </div>

        <!-- Information Box (Clickable to open upcoming tasks modal) -->
        <div id="info-box" class="themed-bg p-4 rounded-xl shadow-lg cursor-pointer">
            <p id="info-box-content" class="font-semibold themed-text-secondary">Select a current day to view upcoming tasks.</p>
            <button id="info-box-clear-selection" class="hidden mt-2 px-3 py-1 text-xs rounded-md bg-gray-600 hover:bg-gray-700 text-white transition-colors">Clear Selection</button>
        </div>

        <div id="timetable" class="timetable-grid themed-bg p-2 rounded-xl"></div>

        <div id="weekly-goal-section" class="mt-8 themed-bg p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold themed-text mb-4">Goal for the Week</h2>
            <textarea id="weekly-goal" class="w-full themed-bg-tertiary themed-text p-4 rounded-lg border-2 border-transparent themed-border-focus transition" placeholder="Define your main objective for this week..."></textarea>
        </div>
    </div>

    <!-- Task Modal (existing) -->
    <div id="task-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 themed-text">Add New Task</h2>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <input type="hidden" id="hidden-task-day">
                <input type="hidden" id="hidden-task-row">
                <input type="hidden" id="task-course-id">
                <input type="hidden" id="task-class-id">

                <div id="task-details-section">
                    <div class="mb-4">
                        <label for="task-name" class="block text-sm font-medium themed-text-secondary mb-2">Task / Class Name</label>
                        <textarea id="task-name" class="w-full themed-bg-tertiary themed-text px-4 py-2 rounded-lg border-2 themed-border themed-border-focus transition" rows="2" required></textarea>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium themed-text-secondary mb-2">Color Tag</label>
                        <div id="color-picker" class="flex flex-wrap gap-3">
                            <!-- Colors will be dynamically added here -->
                        </div>
                        <input type="hidden" id="task-color" value="bg-blue-500">
                    </div>

                    <!-- New fields for class details -->
                    <div id="class-specific-fields" class="space-y-4">
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label for="class-start-time" class="block text-sm font-medium themed-text-secondary mb-2">Start Time</label>
                                <input type="time" id="class-start-time" class="w-full themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition">
                            </div>
                            <div class="flex-1">
                                <label for="class-end-time" class="block text-sm font-medium themed-text-secondary mb-2">End Time (Optional)</label>
                                <input type="time" id="class-end-time" class="w-full themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition">
                            </div>
                        </div>
                        <div>
                            <label for="class-location-type" class="block text-sm font-medium themed-text-secondary mb-2">Location</label>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center themed-text-secondary">
                                    <input type="radio" name="locationType" value="Online" class="mr-2 accent-indigo-600" checked> Online
                                </label>
                                <label class="flex items-center themed-text-secondary">
                                    <input type="radio" name="locationType" value="In-person" class="mr-2 accent-indigo-600"> In-person
                                </label>
                            </div>
                            <input type="text" id="class-venue" class="w-full themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition mt-2 hidden" placeholder="Venue (e.g., Building A, Room 101)">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="delete-task-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition hidden">Delete</button>
                    <button type="button" id="cancel-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Save Task</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Link Modal (existing) -->
    <div id="link-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 id="link-modal-title" class="text-2xl font-bold mb-6 themed-text">Add New Link</h2>
            <form id="link-form">
                <input type="hidden" id="link-id">
                <div class="mb-4">
                    <label for="link-name" class="block text-sm font-medium themed-text-secondary mb-2">Link Name</label>
                    <input type="text" id="link-name" class="w-full themed-bg-tertiary themed-text px-4 py-2 rounded-lg border-2 themed-border themed-border-focus transition" required>
                </div>
                <div class="mb-6">
                    <label for="link-url" class="block text-sm font-medium themed-text-secondary mb-2">URL</label>
                    <input type="url" id="link-url" class="w-full themed-bg-tertiary themed-text px-4 py-2 rounded-lg border-2 themed-border themed-border-focus transition" placeholder="https://example.com" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="delete-link-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition hidden">Delete</button>
                    <button type="button" id="cancel-link-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Save Link</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reset Modal (existing) -->
    <div id="reset-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8 text-center">
            <h2 class="text-2xl font-bold mb-6 themed-text">Reset Timetable Data</h2>
            <p class="themed-text-secondary mb-8">Choose how you want to reset your timetable tasks. Quick links will not be affected.</p>
            <div class="flex flex-col gap-4">
                <button id="clear-current-week-btn" class="px-6 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition">Clear Current Week's Tasks</button>
                <button id="clear-all-weeks-btn" class="px-6 py-3 rounded-lg bg-red-800 hover:bg-red-900 text-white font-semibold transition">Clear All Weeks' Tasks</button>
                <button id="cancel-reset-btn" class="px-6 py-3 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Background Options Modal (existing) -->
    <div id="background-options-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8 text-center">
            <h2 class="text-2xl font-bold mb-6 themed-text">Background Options</h2>
            <p class="themed-text-secondary mb-8">What would you like to do with the background?</p>
            <div class="flex flex-col gap-4">
                <button id="revert-background-btn" class="px-6 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition">Revert to Default Background</button>
                <button id="upload-new-background-btn" class="px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Upload New Background</button>
                <button id="cancel-background-options-btn" class="px-6 py-3 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Animation Settings Modal (existing) -->
    <div id="animation-settings-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8 text-center">
            <h2 class="text-2xl font-bold mb-6 themed-text">Animation Settings</h2>
            <p class="themed-text-secondary mb-8">Choose your preferred animation level:</p>
            <div class="flex flex-col gap-4">
                <button id="animation-normal-btn" class="px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Normal Animations</button>
                <button id="animation-reduced-btn" class="px-6 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition">Reduced Animations</button>
                <button id="animation-none-btn" class="px-6 py-3 rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold transition">No Animations</button>
                <button id="cancel-animation-settings-btn" class="px-6 py-3 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Course Modal (Now specifically for adding/editing course details) -->
    <div id="course-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 id="course-modal-title" class="text-2xl font-bold mb-6 themed-text">Add New Course</h2>
            <form id="course-form">
                <input type="hidden" id="course-id">
                <div class="mb-4">
                    <label for="course-name" class="block text-sm font-medium themed-text-secondary mb-2">Course Name</label>
                    <input type="text" id="course-name" class="w-full themed-bg-tertiary themed-text px-4 py-2 rounded-lg border-2 themed-border themed-border-focus transition" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium themed-text-secondary mb-2">Color Tag</label>
                    <div id="course-color-picker" class="flex flex-wrap gap-3">
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-red-500" data-color="bg-red-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-blue-500" data-color="bg-blue-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-green-500" data-color="bg-green-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-yellow-500" data-color="bg-yellow-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-purple-500" data-color="bg-purple-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-pink-500" data-color="bg-pink-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-indigo-500" data-color="bg-indigo-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-teal-500" data-color="bg-teal-500"></div>
                        <div class="color-option w-8 h-8 rounded-full cursor-pointer bg-orange-500" data-color="bg-orange-500"></div>
                    </div>
                    <input type="hidden" id="course-color" value="bg-blue-500">
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="delete-course-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition hidden">Delete</button>
                    <button type="button" id="cancel-course-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Save Course</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW Course Management Modal -->
    <div id="course-management-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 id="course-management-title" class="text-2xl font-bold mb-4 themed-text">Manage Course: <span id="managed-course-name"></span></h2>
            <p id="managed-course-color-display" class="text-sm themed-text-secondary mb-6"></p>

            <div class="space-y-4 mb-6">
                <button type="button" id="edit-course-details-btn" class="w-full px-4 py-2 text-sm rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Edit Course Details</button>
                
                <div class="mt-4 pt-4 border-t border-gray-600">
                    <h3 class="text-lg font-semibold themed-text mb-3">Classes</h3>
                    <div id="managed-course-classes-list" class="mb-4 max-h-40 overflow-y-auto border border-gray-700 rounded-lg p-2">
                        <!-- Classes for the managed course will be listed here -->
                        <p class="themed-text-secondary text-sm">No classes added for this course.</p>
                    </div>
                    <button type="button" id="add-new-class-to-course-btn" class="w-full px-4 py-2 text-sm rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold transition">Add New Class</button>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-600 flex flex-col gap-2">
                    <button type="button" id="manage-class-types-from-course-mgmt-btn" class="w-full px-4 py-2 text-sm rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold transition">Manage Class Types</button>
                    <button type="button" id="manage-venues-from-course-mgmt-btn" class="w-full px-4 py-2 text-sm rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-semibold transition">Manage Venues</button>
                </div>
            </div>

            <div class="flex justify-end gap-4">
                <button type="button" id="delete-course-from-mgmt-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition">Delete Course</button>
                <button type="button" id="close-course-management-modal-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Close</button>
            </div>
        </div>
    </div>


    <!-- NEW Class Modal (for adding/editing individual classes within a course) -->
    <div id="class-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 id="class-modal-title" class="text-2xl font-bold mb-6 themed-text">Add New Class</h2>
            <form id="class-form">
                <input type="hidden" id="class-id">
                <input type="hidden" id="class-course-parent-id">

                <div class="mb-4">
                    <label for="class-name" class="block text-sm font-medium themed-text-secondary mb-2">Class Name</label>
                    <input type="text" id="class-name" class="w-full themed-bg-tertiary themed-text px-4 py-2 rounded-lg border-2 themed-border themed-border-focus transition" required>
                </div>

                <div class="mb-4">
                    <label for="class-type" class="block text-sm font-medium themed-text-secondary mb-2">Class Type</label>
                    <select id="class-type" class="w-full themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition"></select>
                </div>

                <div class="flex gap-2 mb-4">
                    <div class="flex-1">
                        <label for="class-start-time-modal" class="block text-sm font-medium themed-text-secondary mb-2">Start Time</label>
                        <input type="time" id="class-start-time-modal" class="w-full themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition">
                    </div>
                    <div class="flex-1">
                        <label for="class-end-time-modal" class="block text-sm font-medium themed-text-secondary mb-2">End Time (Optional)</label>
                        <input type="time" id="class-end-time-modal" class="w-full themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium themed-text-secondary mb-2">Location</label>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center themed-text-secondary">
                            <input type="radio" name="classLocationType" value="Online" class="mr-2 accent-indigo-600" checked> Online
                        </label>
                        <label class="flex items-center themed-text-secondary">
                            <input type="radio" name="classLocationType" value="In-person" class="mr-2 accent-indigo-600"> In-person
                        </label>
                    </div>
                    <input type="text" id="class-venue-modal" class="w-full themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition mt-2 hidden" placeholder="Venue (e.g., Building A, Room 101)">
                </div>

                <div class="flex justify-end gap-4">
                    <button type="button" id="delete-class-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition hidden">Delete</button>
                    <button type="button" id="cancel-class-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Save Class</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW Class Type Management Modal -->
    <div id="class-type-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold mb-6 themed-text">Manage Class Types</h2>
            <div id="class-types-list" class="mb-4 max-h-40 overflow-y-auto border border-gray-700 rounded-lg p-2">
                <!-- Class types will be listed here -->
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="new-class-type-name" class="flex-grow themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition" placeholder="New type name">
                <button type="button" id="add-class-type-btn" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Add</button>
            </div>
            <div class="flex justify-end">
                <button type="button" id="close-class-type-modal-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Done</button>
            </div>
        </div>
    </div>

    <!-- NEW Venue Management Modal -->
    <div id="venue-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold mb-6 themed-text">Manage Venues</h2>
            <div id="venues-list" class="mb-4 max-h-40 overflow-y-auto border border-gray-700 rounded-lg p-2">
                <!-- Venues will be listed here -->
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="new-venue-name" class="flex-grow themed-bg-tertiary themed-text px-3 py-2 rounded-lg border-2 themed-border themed-border-focus transition" placeholder="New venue name">
                <button type="button" id="add-venue-btn" class="px-4 py-2 text-sm rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Add</button>
            </div>
            <div class="flex justify-end">
                <button type="button" id="close-venue-modal-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Done</button>
            </div>
        </div>
    </div>

    <!-- NEW Select Class/Custom Task Modal (appears when clicking + in Class row) -->
    <div id="select-class-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold mb-6 themed-text">Add Class or Custom Task</h2>
            
            <div class="mb-4">
                <button id="add-custom-task-btn" class="w-full px-4 py-2 text-sm rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold transition mb-4">Add Custom Task</button>
            </div>

            <h3 class="text-lg font-semibold themed-text mb-3">Select from My Courses:</h3>
            <div id="select-course-list" class="max-h-60 overflow-y-auto mb-6 border border-gray-700 rounded-lg p-2">
                <!-- Courses and their classes will be dynamically loaded here -->
                <p class="themed-text-secondary text-sm">No courses with classes available.</p>
            </div>

            <div class="flex justify-end">
                <button type="button" id="cancel-select-class-modal-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Cancel</button>
            </div>
        </div>
    </div>


    <!-- NEW Upcoming Tasks Details Modal -->
    <div id="upcoming-tasks-details-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content w-full max-w-md rounded-2xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold mb-6 themed-text">All Upcoming Tasks</h2>
            <div id="upcoming-tasks-modal-list" class="max-h-80 overflow-y-auto mb-6">
                <!-- Upcoming tasks will be listed here dynamically -->
                <p class="themed-text-secondary text-sm">No upcoming tasks to display.</p>
            </div>
            <div class="flex justify-end">
                <button type="button" id="close-upcoming-tasks-modal-btn" class="px-6 py-2 rounded-lg themed-bg-tertiary hover:bg-gray-500 themed-text font-semibold transition">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Function to show a custom message box instead of alert()
        function showMessageBox(message) {
            document.getElementById('messageText').innerText = message;
            document.getElementById('messageBox').style.display = 'block';
        }

        // Function to hide the custom message box
        function hideMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const timetable = document.getElementById('timetable');
            const taskModal = document.getElementById('task-modal');
            const linkModal = document.getElementById('link-modal');
            const resetModal = document.getElementById('reset-modal');
            const backgroundOptionsModal = document.getElementById('background-options-modal');
            const animationSettingsModal = document.getElementById('animation-settings-modal');
            const courseModal = document.getElementById('course-modal'); 
            const themeToggle = document.getElementById('theme-toggle');
            const toggleDeleteLinkBtn = document.getElementById('toggle-delete-link-btn');
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const importDataInput = document.getElementById('import-data-input');
            const backgroundUploadInput = document.getElementById('background-upload-input');
            const uploadBackgroundBtn = document.getElementById('upload-background-btn');
            const revertBackgroundBtn = document.getElementById('revert-background-btn');
            const uploadNewBackgroundBtn = document.getElementById('upload-new-background-btn');
            const cancelBackgroundOptionsBtn = document.getElementById('cancel-background-options-btn');
            const animationSettingsBtn = document.getElementById('animation-settings-btn');
            const animationNormalBtn = document.getElementById('animation-normal-btn');
            const animationReducedBtn = document.getElementById('animation-reduced-btn');
            const animationNoneBtn = document.getElementById('animation-none-btn');
            const cancelAnimationSettingsBtn = document.getElementById('cancel-animation-settings-btn');
            const addCourseBtn = document.getElementById('add-course-btn'); 
            const clearCourseSelectionBtn = document.getElementById('clear-course-selection-btn'); 
            const toggleDeleteCourseBtn = document.getElementById('toggle-delete-course-btn'); 
            
            // Elements for blur functionality
            const blurSlider = document.getElementById('blur-slider');

            // Sidebar Elements
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const toggleUpcomingTasksBtn = document.getElementById('toggle-upcoming-tasks');
            const upcomingTasksContent = document.getElementById('upcoming-tasks-content');
            const upcomingTasksToggleIcon = document.getElementById('upcoming-tasks-toggle-icon');
            const upcomingTaskNameInput = document.getElementById('upcoming-task-name');
            const upcomingTaskTargetWeekInput = document.getElementById('upcoming-task-target-week');
            const upcomingTaskTargetDaySelect = document.getElementById('upcoming-task-target-day');
            const saveUpcomingTaskBtn = document.getElementById('save-upcoming-task-btn');
            const upcomingTasksList = document.getElementById('upcoming-tasks-list');

            // Info Box Elements
            const infoBox = document.getElementById('info-box');
            const infoBoxContent = document.getElementById('info-box-content');
            const infoBoxClearSelectionBtn = document.getElementById('info-box-clear-selection');

            // New Upcoming Tasks Details Modal Elements
            const upcomingTasksDetailsModal = document.getElementById('upcoming-tasks-details-modal');
            const upcomingTasksModalList = document.getElementById('upcoming-tasks-modal-list');
            const closeUpcomingTasksModalBtn = document.getElementById('close-upcoming-tasks-modal-btn');

            // New Class/Course related elements
            const courseClassesManagement = document.getElementById('course-classes-management'); // This is now unused in course-modal
            const courseClassesList = document.getElementById('course-classes-list'); // This is now unused in course-modal
            const addClassBtn = document.getElementById('add-class-btn'); // This is now unused in course-modal
            const manageClassTypesBtn = document.getElementById('manage-class-types-btn'); // This is now unused in course-modal
            const manageVenuesBtn = document.getElementById('manage-venues-btn'); // This is now unused in course-modal

            const classModal = document.getElementById('class-modal');
            const classModalTitle = document.getElementById('class-modal-title');
            const classForm = document.getElementById('class-form');
            const classIdInput = document.getElementById('class-id');
            const classCourseParentIdInput = document.getElementById('class-course-parent-id');
            const classNameInput = document.getElementById('class-name');
            const classTypeSelect = document.getElementById('class-type');
            const classStartTimeModal = document.getElementById('class-start-time-modal');
            const classEndTimeModal = document.getElementById('class-end-time-modal');
            const classLocationTypeRadios = document.querySelectorAll('input[name="classLocationType"]');
            const classVenueModal = document.getElementById('class-venue-modal');
            const deleteClassBtn = document.getElementById('delete-class-btn');
            const cancelClassBtn = document.getElementById('cancel-class-btn');

            const classTypeModal = document.getElementById('class-type-modal');
            const classTypesList = document.getElementById('class-types-list');
            const newClassTypeNameInput = document.getElementById('new-class-type-name');
            const addClassTypeBtn = document.getElementById('add-class-type-btn');
            const closeClassTypeModalBtn = document.getElementById('close-class-type-modal-btn');

            const venueModal = document.getElementById('venue-modal');
            const venuesList = document.getElementById('venues-list');
            const newVenueNameInput = document.getElementById('new-venue-name');
            const addVenueBtn = document.getElementById('add-venue-btn');
            const closeVenueModalBtn = document.getElementById('close-venue-modal-btn');

            const selectClassModal = document.getElementById('select-class-modal');
            const addCustomTaskBtn = document.getElementById('add-custom-task-btn');
            const selectCourseList = document.getElementById('select-course-list');
            const cancelSelectClassModalBtn = document.getElementById('cancel-select-class-modal-btn');

            // Task Modal specific fields for class details
            const classSpecificFields = document.getElementById('class-specific-fields');
            const taskCourseIdInput = document.getElementById('task-course-id');
            const taskClassIdInput = document.getElementById('task-class-id');
            const taskStartTimeInput = document.getElementById('class-start-time');
            const taskEndTimeInput = document.getElementById('class-end-time');
            const taskLocationTypeRadios = document.querySelectorAll('input[name="locationType"]');
            const taskVenueInput = document.getElementById('class-venue');

            // New Course Management Modal elements
            const courseManagementModal = document.getElementById('course-management-modal');
            const managedCourseNameDisplay = document.getElementById('managed-course-name');
            const managedCourseColorDisplay = document.getElementById('managed-course-color-display');
            const editCourseDetailsBtn = document.getElementById('edit-course-details-btn');
            const managedCourseClassesList = document.getElementById('managed-course-classes-list');
            const addNewClassToCourseBtn = document.getElementById('add-new-class-to-course-btn');
            const manageClassTypesFromCourseMgmtBtn = document.getElementById('manage-class-types-from-course-mgmt-btn');
            const manageVenuesFromCourseMgmtBtn = document.getElementById('manage-venues-from-course-mgmt-btn');
            const deleteCourseFromMgmtBtn = document.getElementById('delete-course-from-mgmt-btn');
            const closeCourseManagementModalBtn = document.getElementById('close-course-management-modal-btn');
            
            let currentlyManagedCourseId = null; // Stores the ID of the course currently open in courseManagementModal


            // --- State Variables ---
            const days = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const rowLabels = ['Class', 'Prio 1', 'Prio 2', 'Prio 3', 'Prio 4', 'Done'];
            let currentWeek = 1;
            let tasks = {}; // { 'week-day-row': [{id, name, color, completed, courseId, classId, startTime, endTime, locationType, venue}, ...] }
            let links = []; // [{id, name, url}]
            let courses = []; // [{id, name, color, classes: [{id, name, type, startTime, endTime, locationType, venue}]}]
            let upcomingTasks = []; // [{id, name, targetWeek, targetDay, color, type, startTime, endTime, location, courseId}]
            let activeCourseId = null; // ID of the currently selected course
            let activeCourseColor = 'bg-blue-500'; // Default color for tasks if no course selected
            let isLinkDeleteMode = false;
            let isCourseDeleteMode = false; 
            let weekDates = {}; // { 'weekNumber': 'YYYY-MM-DD' (date of Saturday for that week) }
            let animationLevel = 'normal'; // 'normal', 'reduced', 'none'
            let selectedDay = { week: null, dayIndex: null }; // { week: currentWeek, dayIndex: 0-6 }
            let displayedUpcomingTaskId = null; // Stores the ID of the upcoming task currently displayed in the info box
            let classTypes = ['Lecture', 'Workshop', 'Tutorial', 'LAB']; // Default class types
            let venues = []; // User-defined venues


            // --- Date Formatting Helper ---
            const formatDate = (date) => {
                const options = { day: 'numeric', month: 'long' };
                const formattedDate = date.toLocaleDateString('en-US', options);
                const day = date.getDate();
                let suffix;
                if (day > 3 && day < 21) suffix = 'th';
                else {
                    switch (day % 10) {
                        case 1: suffix = 'st'; break;
                        case 2: suffix = 'nd'; break;
                        case 3: suffix = 'rd'; break;
                        default: suffix = 'th';
                    }
                }
                return `${day}${suffix} of ${date.toLocaleDateString('en-US', { month: 'long' })}`;
            };

            // --- State Management ---
            function loadState() {
                const savedTasks = localStorage.getItem('timetableTasks_v2');
                const savedLinks = localStorage.getItem('timetableLinks');
                const savedCourses = localStorage.getItem('timetableCourses'); 
                const savedUpcomingTasks = localStorage.getItem('upcomingTasks');
                const savedActiveCourseId = localStorage.getItem('activeCourseId'); 
                const savedActiveCourseColor = localStorage.getItem('activeCourseColor'); 
                const savedWeek = localStorage.getItem('timetableWeek');
                const savedGoal = localStorage.getItem('timetableGoal');
                const savedTheme = localStorage.getItem('timetableTheme');
                const savedWeekDates = localStorage.getItem('timetableWeekDates');
                const savedBackground = localStorage.getItem('customBackground');
                const savedBlurAmount = localStorage.getItem('blurAmount');
                const savedAnimationLevel = localStorage.getItem('animationLevel');
                const savedIsCourseDeleteMode = localStorage.getItem('isCourseDeleteMode'); 
                const savedSelectedDay = localStorage.getItem('selectedDay');
                const savedDisplayedUpcomingTaskId = localStorage.getItem('displayedUpcomingTaskId');
                const savedClassTypes = localStorage.getItem('classTypes');
                const savedVenues = localStorage.getItem('venues');


                if (savedTasks) tasks = JSON.parse(savedTasks);
                if (savedLinks) links = JSON.parse(savedLinks);
                if (savedCourses) courses = JSON.parse(savedCourses); 
                if (savedUpcomingTasks) upcomingTasks = JSON.parse(savedUpcomingTasks);
                if (savedActiveCourseId) activeCourseId = savedActiveCourseId; 
                if (savedActiveCourseColor) activeCourseColor = savedActiveCourseColor; 
                if (savedWeek) currentWeek = parseInt(savedWeek, 10);
                if (savedGoal) document.getElementById('weekly-goal').value = savedGoal;
                if (savedTheme) document.body.classList.toggle('light-mode', savedTheme === 'light');
                if (savedWeekDates) weekDates = JSON.parse(savedWeekDates);
                if (savedIsCourseDeleteMode) isCourseDeleteMode = JSON.parse(savedIsCourseDeleteMode); 
                if (savedSelectedDay) selectedDay = JSON.parse(savedSelectedDay);
                if (savedDisplayedUpcomingTaskId) displayedUpcomingTaskId = savedDisplayedUpcomingTaskId;
                if (savedClassTypes) classTypes = JSON.parse(savedClassTypes);
                if (savedVenues) venues = JSON.parse(savedVenues);
                
                // Apply saved background and blur
                if (savedBackground) {
                    document.body.style.backgroundImage = `url('${savedBackground}')`;
                    document.body.classList.add('custom-background-active'); // Add class to enable blur styles
                    blurSlider.disabled = false; // Enable slider
                    const blurValue = savedBlurAmount ? parseFloat(savedBlurAmount) : 5; // Default blur if not saved
                    blurSlider.value = blurValue;
                    document.body.style.setProperty('--current-blur-amount', `${blurValue}px`);
                } else {
                    document.body.style.backgroundImage = '';
                    document.body.classList.remove('custom-background-active'); // Remove class to disable blur styles
                    blurSlider.disabled = true; // Disable slider
                    blurSlider.value = 0;
                    document.body.style.setProperty('--current-blur-amount', `0px`);
                }

                // Apply saved animation level
                animationLevel = savedAnimationLevel || 'normal';
                applyAnimationLevel(animationLevel);

                // Initialize current week's date if not set
                if (!weekDates[currentWeek]) {
                    setWeekToCurrentDate(currentWeek);
                }
                updateThemeIcon();
                // Update delete button text on load
                toggleDeleteCourseBtn.textContent = isCourseDeleteMode ? 'Done' : 'Delete';
                toggleDeleteCourseBtn.classList.toggle('bg-red-600', isCourseDeleteMode);
                toggleDeleteCourseBtn.classList.toggle('hover:bg-red-700', isCourseDeleteMode);
                toggleDeleteCourseBtn.classList.toggle('bg-gray-600', !isCourseDeleteMode);
                toggleDeleteCourseBtn.classList.toggle('hover:bg-gray-700', !isCourseDeleteMode);
            }

            function saveState() {
                localStorage.setItem('timetableTasks_v2', JSON.stringify(tasks));
                localStorage.setItem('timetableLinks', JSON.stringify(links));
                localStorage.setItem('timetableCourses', JSON.stringify(courses)); 
                localStorage.setItem('upcomingTasks', JSON.stringify(upcomingTasks));
                localStorage.setItem('activeCourseId', activeCourseId); 
                localStorage.setItem('activeCourseColor', activeCourseColor); 
                localStorage.setItem('timetableWeek', currentWeek);
                localStorage.setItem('timetableGoal', document.getElementById('weekly-goal').value);
                localStorage.setItem('timetableTheme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
                localStorage.setItem('timetableWeekDates', JSON.stringify(weekDates));
                localStorage.setItem('animationLevel', animationLevel);
                localStorage.setItem('isCourseDeleteMode', isCourseDeleteMode); 
                localStorage.setItem('selectedDay', JSON.stringify(selectedDay));
                localStorage.setItem('displayedUpcomingTaskId', displayedUpcomingTaskId); // Save displayed task ID
                localStorage.setItem('classTypes', JSON.stringify(classTypes));
                localStorage.setItem('venues', JSON.stringify(venues));
                
                const currentBackground = document.body.style.backgroundImage;
                if (currentBackground && currentBackground.startsWith('url("data:image/')) {
                    localStorage.setItem('customBackground', currentBackground.slice(5, -2)); // Remove url("")
                    localStorage.setItem('blurAmount', blurSlider.value); // Save blur amount
                } else {
                    localStorage.removeItem('customBackground');
                    localStorage.removeItem('blurAmount'); // Remove blur amount if no custom background
                }
            }
            
            // --- Date Calculation and Setting ---
            function getSaturdayDateForWeek(weekNum) {
                const dateStr = weekDates[weekNum];
                if (dateStr) {
                    return new Date(dateStr + 'T00:00:00'); // Add T00:00:00 to ensure consistent timezone interpretation
                }
                return null;
            }

            function setSaturdayDateForWeek(weekNum, saturdayDate) {
                weekDates[weekNum] = saturdayDate.toISOString().split('T')[0]; // Store as YYYY-MM-DD
                saveState();
            }

            function updateDatesFromReference(referenceDayIndex, referenceDate) {
                // Calculate Saturday's date for the current week based on the reference
                const saturdayDate = new Date(referenceDate);
                saturdayDate.setDate(referenceDate.getDate() - referenceDayIndex); // dayIndex: 0 for Saturday, 1 for Sunday, etc.
                
                setSaturdayDateForWeek(currentWeek, saturdayDate);
                
                // Recalculate dates for other weeks
                // Adjust the range if you need more weeks to be auto-updated
                for (let i = -52; i <= 52; i++) { // Recalculate for a range of +/- 1 year (approx 52 weeks)
                    if (i === 0) continue; // Skip current week as it's already set
                    const targetWeek = currentWeek + i;
                    const newSaturdayDate = new Date(saturdayDate);
                    newSaturdayDate.setDate(saturdayDate.getDate() + (i * 7));
                    setSaturdayDateForWeek(targetWeek, newSaturdayDate);
                }

                // If the selected day's date changes, update it
                if (selectedDay.week === currentWeek) {
                    // Re-evaluate the selected day's date based on the new weekDates
                    const currentSelectedWeekSaturday = getSaturdayDateForWeek(selectedDay.week);
                    if (currentSelectedWeekSaturday) {
                        const newSelectedDate = new Date(currentSelectedWeekSaturday);
                        newSelectedDate.setDate(currentSelectedWeekSaturday.getDate() + selectedDay.dayIndex);
                        selectedDay.date = newSelectedDate.toISOString().split('T')[0];
                        saveState();
                        renderInfoBoxContent(); // Update info box immediately
                    }
                }

                renderTimetable();
            }

            function setWeekToCurrentDate(weekNum) {
                const today = new Date();
                const todayDayIndex = (today.getDay() + 6) % 7; // Convert to 0=Sat, 1=Sun...
                
                const saturdayDate = new Date(today);
                saturdayDate.setDate(today.getDate() - todayDayIndex);
                setSaturdayDateForWeek(weekNum, saturdayDate);
            }

            // --- UI Rendering ---
            function renderTimetable() {
                timetable.innerHTML = '';
                document.getElementById('week-display').textContent = `Week ${currentWeek}`;

                // Header row (empty cell, then days)
                timetable.appendChild(document.createElement('div'));

                const currentWeekSaturday = getSaturdayDateForWeek(currentWeek);
                const tempDate = currentWeekSaturday ? new Date(currentWeekSaturday) : null;

                days.forEach((dayName, dayIndex) => {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'text-center font-semibold themed-text-secondary py-3 day-header flex flex-col items-center justify-center';
                    headerCell.dataset.dayIndex = dayIndex; // Store day index for event listener

                    const daySpan = document.createElement('span');
                    daySpan.textContent = dayName;
                    headerCell.appendChild(daySpan);

                    if (tempDate) {
                        const dateForDay = new Date(tempDate);
                        dateForDay.setDate(tempDate.getDate() + dayIndex); // Add days from Saturday
                        const dateDisplay = document.createElement('div');
                        dateDisplay.className = 'text-xs font-normal themed-text-secondary mt-1';
                        dateDisplay.textContent = formatDate(dateForDay);
                        headerCell.appendChild(dateDisplay);
                    }

                    // Current Day Checkbox
                    const checkbox = document.createElement('div');
                    checkbox.className = `current-day-checkbox mt-2 ${selectedDay.week === currentWeek && selectedDay.dayIndex === dayIndex ? 'checked' : ''}`;
                    checkbox.addEventListener('click', () => {
                        // Uncheck previous selected day in local storage if exists
                        if (selectedDay.week !== null && selectedDay.dayIndex !== null) {
                            const prevCheckbox = document.querySelector(`.current-day-checkbox.checked`);
                            if (prevCheckbox) {
                                prevCheckbox.classList.remove('checked');
                            }
                        }
                        
                        // Set new selected day
                        selectedDay = { week: currentWeek, dayIndex: dayIndex };
                        checkbox.classList.add('checked');
                        displayedUpcomingTaskId = null; // Clear any explicitly selected upcoming task when a new day is chosen
                        saveState();
                        renderInfoBoxContent(); // Update info box immediately
                    });
                    headerCell.appendChild(checkbox);
                    
                    headerCell.addEventListener('click', (e) => {
                        // Prevent date prompt if clicking the checkbox
                        if (e.target.classList.contains('current-day-checkbox')) {
                            return;
                        }

                        let newDate;
                        let validDate = false;
                        while(!validDate) {
                            newDate = prompt(`Set date for ${dayName} (DD/MM). E.g., 02/07`);
                            if (newDate === null) { // User cancelled
                                return;
                            }
                            const [day, month] = newDate.split('/').map(Number);
                            // Basic validation for DD/MM format and valid numbers
                            if (day && month && !isNaN(day) && !isNaN(month) && day >= 1 && day <= 31 && month >= 1 && month <= 12) {
                                validDate = true;
                                const year = (new Date()).getFullYear(); // Assume current year for input
                                const setDate = new Date(year, month - 1, day);
                                updateDatesFromReference(dayIndex, setDate);
                            } else {
                                showMessageBox('Invalid date format or values. Please use DD/MM (e.g., 02/07) with valid day/month numbers.');
                            }
                        }
                    });
                    timetable.appendChild(headerCell);
                });

                for (let i = 0; i < 6; i++) {
                    const labelCell = document.createElement('div');
                    labelCell.className = 'text-center text-sm font-medium themed-text-secondary flex items-center justify-center';
                    labelCell.textContent = rowLabels[i];
                    timetable.appendChild(labelCell);

                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('div');
                        // Add 'themed-bg' to grid-cell so it picks up the blur styles
                        cell.className = 'grid-cell rounded-lg min-h-[100px] p-2 flex flex-col items-center gap-1 themed-bg'; 
                        cell.dataset.day = j;
                        cell.dataset.row = i;
                        
                        const taskKey = `${currentWeek}-${j}-${i}`;
                        if (tasks[taskKey] && tasks[taskKey].length > 0) {
                            tasks[taskKey].forEach(task => cell.appendChild(createTaskCard(task)));
                        }
                        
                        const addButton = document.createElement('button');
                        addButton.className = 'add-btn mt-auto p-2 rounded-full themed-bg-tertiary hover:bg-indigo-600 text-white transition-all';
                        addButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
                        addButton.onclick = () => {
                            if (i === 0) { // If "Class" row
                                openSelectClassModal(j, i);
                            } else {
                                openTaskModal(j, i); // For other rows, open directly
                            }
                        };
                        cell.appendChild(addButton);
                        timetable.appendChild(cell);
                    }
                }
            }
            
            function createTaskCard(task) {
                const card = document.createElement('div');
                card.className = `task-card p-2 mb-1 rounded-md text-white shadow-md w-full flex flex-col justify-between ${task.color}`;
                if (task.completed) card.classList.add('completed-task');
                card.dataset.taskId = task.id;
                
                const taskName = document.createElement('p');
                taskName.className = 'font-semibold text-sm break-words whitespace-pre-wrap';
                taskName.textContent = task.name;

                // Add class details if available
                if (task.startTime || task.locationType) {
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'class-details';
                    let detailsText = '';
                    if (task.startTime) {
                        detailsText += task.startTime;
                        if (task.endTime) detailsText += ` - ${task.endTime}`;
                    }
                    if (task.locationType) {
                        if (detailsText) detailsText += ' | ';
                        detailsText += task.locationType;
                        if (task.locationType === 'In-person' && task.venue) {
                            detailsText += `: ${task.venue}`;
                        }
                    }
                    detailsDiv.textContent = detailsText;
                    card.appendChild(detailsDiv);
                }

                const cardFooter = document.createElement('div');
                cardFooter.className = 'flex items-center justify-between mt-2';
                
                const statusDot = document.createElement('div');
                statusDot.className = 'status-dot w-3 h-3 rounded-full';
                statusDot.style.backgroundColor = task.completed ? '#4ade80' : '#f87171';

                const completeToggle = document.createElement('input');
                completeToggle.type = 'checkbox';
                completeToggle.checked = task.completed;
                completeToggle.className = "w-4 h-4 rounded text-indigo-500 bg-gray-700 border-gray-600 focus:ring-indigo-600 focus:ring-2";
                completeToggle.onclick = (e) => { e.stopPropagation(); toggleTaskCompletion(task.id); };

                cardFooter.appendChild(statusDot);
                cardFooter.appendChild(completeToggle);
                card.appendChild(taskName);
                card.appendChild(cardFooter);
                card.onclick = () => openTaskModal(task.day, task.row, task);
                return card;
            }

            function renderLinks() {
                const container = document.getElementById('links-container');
                container.innerHTML = '';
                if (links.length === 0 && !isLinkDeleteMode) {
                    container.innerHTML = `<p class="themed-text-secondary text-sm">No links added yet. Click 'Add Link' to get started.</p>`;
                } else if (links.length === 0 && isLinkDeleteMode) {
                       container.innerHTML = `<p class="themed-text-secondary text-sm">No links to delete.</p>`;
                }

                links.forEach(link => {
                    const linkEl = document.createElement('a');
                    linkEl.href = link.url;
                    linkEl.target = '_blank';
                    linkEl.rel = 'noopener noreferrer';
                    linkEl.className = 'px-4 py-2 rounded-lg themed-bg-tertiary themed-text font-semibold transition hover:opacity-80';
                    linkEl.textContent = link.name;
                    
                    if (isLinkDeleteMode) {
                        linkEl.classList.add('deletable-link');
                        linkEl.onclick = (e) => {
                            e.preventDefault();
                            deleteLink(link.id);
                        };
                    } else {
                        linkEl.onclick = (e) => {
                            if (e.ctrlKey || e.metaKey) {
                                e.preventDefault();
                                openLinkModal(link);
                            }
                        };
                    }
                    container.appendChild(linkEl);
                });
            }

            // Render Courses
            function renderCourses() {
                const container = document.getElementById('courses-container');
                container.innerHTML = ''; // Clear existing courses

                if (courses.length === 0 && !isCourseDeleteMode) {
                    container.innerHTML = `<p class="themed-text-secondary text-sm">No courses added yet. Click 'Add Course' to get started.</p>`;
                } else if (courses.length === 0 && isCourseDeleteMode) {
                    container.innerHTML = `<p class="themed-text-secondary text-sm">No courses to delete.</p>`;
                }

                courses.forEach(course => {
                    const courseCard = document.createElement('div');
                    courseCard.className = `course-card p-2 rounded-md text-white shadow-md cursor-pointer flex items-center justify-center gap-2 ${course.color}`;
                    courseCard.textContent = course.name;
                    courseCard.dataset.courseId = course.id;

                    if (activeCourseId === course.id) {
                        courseCard.classList.add('active'); // Highlight active course
                    }
                    
                    if (isCourseDeleteMode) {
                        courseCard.classList.add('deletable-course');
                        courseCard.onclick = (e) => {
                            e.preventDefault();
                            deleteCourse(course.id);
                        };
                    } else {
                        courseCard.onclick = (e) => {
                            e.preventDefault(); // Prevent default link behavior if any
                            // Select the course as active
                            selectCourse(course.id, course.color);
                            // Open the new course management modal
                            openCourseManagementModal(course);
                        };
                    }
                    container.appendChild(courseCard);
                });
                // Update the display of the clear selection button
                clearCourseSelectionBtn.classList.toggle('hidden', activeCourseId === null || isCourseDeleteMode);
                addCourseBtn.classList.toggle('hidden', isCourseDeleteMode); // Hide add button in delete mode
            }

            // Select Course
            function selectCourse(id, color) {
                activeCourseId = id;
                activeCourseColor = color;
                renderCourses(); // Re-render to highlight
                saveState();
                // Removed showMessageBox
            }

            // Clear Course Selection
            function clearCourseSelection() {
                activeCourseId = null;
                activeCourseColor = 'bg-blue-500'; // Reset to a default task color
                renderCourses(); // Re-render to remove highlight
                saveState();
                // Removed showMessageBox
            }

            // Render Upcoming Tasks in Sidebar
            function renderUpcomingTasks() {
                upcomingTasksList.innerHTML = '';
                if (upcomingTasks.length === 0) {
                    upcomingTasksList.innerHTML = `<p class="themed-text-secondary text-sm">No upcoming tasks added.</p>`;
                } else {
                    upcomingTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `p-2 mb-2 rounded-md ${task.color} text-white text-sm flex flex-col`; // Changed to flex-col
                        taskItem.innerHTML = `
                            <div class="flex justify-between items-center w-full">
                                <span class="font-semibold">${task.name}</span>
                                <button class="delete-upcoming-task-btn p-1 rounded-full bg-red-700 hover:bg-red-800 transition-colors" data-task-id="${task.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                            <span class="text-xs mt-1 self-start">Week ${task.targetWeek}, ${days[task.targetDay]}</span>
                        `; // Added week and day display
                        upcomingTasksList.appendChild(taskItem);
                    });
                    // Add event listeners for delete buttons
                    upcomingTasksList.querySelectorAll('.delete-upcoming-task-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const taskId = e.currentTarget.dataset.taskId;
                            deleteUpcomingTask(taskId);
                        });
                    });
                }
            }

            function deleteUpcomingTask(id) {
                upcomingTasks = upcomingTasks.filter(task => task.id !== id);
                // If the deleted task was the one being displayed in the info box, clear the selection
                if (displayedUpcomingTaskId === id) {
                    displayedUpcomingTaskId = null;
                }
                renderUpcomingTasks();
                renderInfoBoxContent(); // Update info box as well
                saveState();
            }

            // Calculate Days/Weeks Left for Upcoming Tasks
            function calculateDaysWeeksLeft(targetWeek, targetDayIndex) {
                if (selectedDay.week === null || selectedDay.dayIndex === null) {
                    return "Select current day to calculate";
                }

                const currentWeekSaturday = getSaturdayDateForWeek(selectedDay.week);
                const targetWeekSaturday = getSaturdayDateForWeek(targetWeek);

                if (!currentWeekSaturday) {
                    return `Current week (${selectedDay.week}) date not set.`;
                }
                if (!targetWeekSaturday) {
                    return `Target week (${targetWeek}) date not set.`;
                }

                const currentSelectedDate = new Date(currentWeekSaturday);
                currentSelectedDate.setDate(currentWeekSaturday.getDate() + selectedDay.dayIndex);
                currentSelectedDate.setHours(0, 0, 0, 0); // Normalize to start of day

                const targetDate = new Date(targetWeekSaturday);
                targetDate.setDate(targetWeekSaturday.getDate() + targetDayIndex);
                targetDate.setHours(0, 0, 0, 0); // Normalize to start of day

                const diffTime = targetDate.getTime() - currentSelectedDate.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) {
                    return "Passed";
                } else if (diffDays === 0) {
                    return "Today!";
                } else if (diffDays < 7) {
                    return `${diffDays} day${diffDays === 1 ? '' : 's'} left`;
                } else {
                    const weeks = Math.floor(diffDays / 7);
                    const daysRemainder = diffDays % 7;
                    return `${weeks} week${weeks === 1 ? '' : 's'}${daysRemainder > 0 ? ` and ${daysRemainder} day${daysRemainder === 1 ? '' : 's'}` : ''} left`;
                }
            }

            // Render Info Box Content
            function renderInfoBoxContent() {
                let taskToDisplay = null;

                if (displayedUpcomingTaskId) {
                    taskToDisplay = upcomingTasks.find(task => task.id === displayedUpcomingTaskId);
                }

                if (!taskToDisplay) {
                    // If no specific task is selected, or the selected one was deleted, find the next relevant task
                    if (selectedDay.week === null || selectedDay.dayIndex === null) {
                        infoBoxContent.innerHTML = `<p class="font-semibold themed-text-secondary">Select a current day to view upcoming tasks.</p>`;
                        infoBoxClearSelectionBtn.classList.add('hidden');
                        return;
                    }

                    const currentWeekSaturday = getSaturdayDateForWeek(selectedDay.week);
                    if (!currentWeekSaturday) {
                        infoBoxContent.innerHTML = `<p class="font-semibold themed-text-secondary">Error: Current week's date not set. Please set a date for the current day.</p>`;
                        infoBoxClearSelectionBtn.classList.add('hidden');
                        return;
                    }

                    const currentSelectedDateObj = new Date(currentWeekSaturday);
                    currentSelectedDateObj.setDate(currentWeekSaturday.getDate() + selectedDay.dayIndex);
                    currentSelectedDateObj.setHours(0, 0, 0, 0);

                    const relevantTasks = upcomingTasks
                        .filter(task => {
                            const taskWeekSaturday = getSaturdayDateForWeek(task.targetWeek);
                            if (!taskWeekSaturday) return false;

                            const taskDate = new Date(taskWeekSaturday);
                            taskDate.setDate(taskDate.getDate() + task.targetDay);
                            taskDate.setHours(0, 0, 0, 0);
                            return taskDate.getTime() >= currentSelectedDateObj.getTime();
                        })
                        .sort((a, b) => {
                            const dateA = new Date(getSaturdayDateForWeek(a.targetWeek));
                            dateA.setDate(dateA.getDate() + a.targetDay);
                            dateA.setHours(0, 0, 0, 0);

                            const dateB = new Date(getSaturdayDateForWeek(b.targetWeek));
                            dateB.setDate(dateB.getDate() + b.targetDay);
                            dateB.setHours(0, 0, 0, 0);

                            return dateA.getTime() - dateB.getTime();
                        });
                    
                    if (relevantTasks.length > 0) {
                        taskToDisplay = relevantTasks[0];
                        displayedUpcomingTaskId = null; // Ensure it's not set to a specific task ID when showing 'next'
                    }
                }

                if (taskToDisplay) {
                    const daysWeeksLeft = calculateDaysWeeksLeft(taskToDisplay.targetWeek, taskToDisplay.targetDay);
                    infoBoxContent.innerHTML = `
                        <p class="font-semibold themed-text-secondary">${taskToDisplay.name}</p>
                        <p class="text-xs themed-text-secondary">Due: Week ${taskToDisplay.targetWeek}, ${days[taskToDisplay.targetDay]} (${daysWeeksLeft})</p>
                    `;
                    infoBoxClearSelectionBtn.classList.toggle('hidden', displayedUpcomingTaskId === null); // Show only if a specific task is selected
                } else {
                    infoBoxContent.innerHTML = `<p class="font-semibold themed-text-secondary">No upcoming tasks for the selected day or later.</p>`;
                    infoBoxClearSelectionBtn.classList.add('hidden');
                }
                saveState(); // Save the state of displayedUpcomingTaskId
            }

            // Function to open the new modal listing all upcoming tasks
            function openUpcomingTasksDetailsModal() {
                upcomingTasksModalList.innerHTML = ''; // Clear previous list

                if (upcomingTasks.length === 0) {
                    upcomingTasksModalList.innerHTML = `<p class="themed-text-secondary text-sm">No upcoming tasks added yet. Add some via the sidebar.</p>`;
                } else {
                    upcomingTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `upcoming-task-item-modal ${task.color} text-white`;
                        taskItem.dataset.taskId = task.id;
                        taskItem.innerHTML = `
                            <div>
                                <p class="task-name">${task.name}</p>
                                <p class="task-due">Week ${task.targetWeek}, ${days[task.targetDay]}</p>
                            </div>
                            <button class="delete-btn-modal" data-task-id="${task.id}">Delete</button>
                        `;
                        // Click listener for selecting a task to display in the info box
                        taskItem.addEventListener('click', (e) => {
                            // Prevent selecting the task if the delete button was clicked
                            if (e.target.classList.contains('delete-btn-modal')) {
                                return;
                            }
                            displayedUpcomingTaskId = task.id;
                            renderInfoBoxContent();
                            closeModal(upcomingTasksDetailsModal);
                        });
                        // Click listener for deleting directly from the modal list
                        taskItem.querySelector('.delete-btn-modal').addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent the parent taskItem click from firing
                            deleteUpcomingTask(task.id);
                            // Re-render the modal list after deletion
                            openUpcomingTasksDetailsModal(); // Re-open to show updated list
                        });
                        upcomingTasksModalList.appendChild(taskItem);
                    });
                }
                openModal(upcomingTasksDetailsModal);
            }

            // --- Modal Logic ---
            function openTaskModal(day, row, task = null) {
                openModal(taskModal);
                const form = document.getElementById('task-form');
                form.reset();
                document.getElementById('delete-task-btn').classList.toggle('hidden', !task);
                document.getElementById('modal-title').textContent = task ? 'Edit Task' : 'Add New Task';
                
                document.getElementById('hidden-task-day').value = day;
                document.getElementById('hidden-task-row').value = row;
                
                // Dynamically populate task color picker with all available colors
                const taskColorPicker = document.getElementById('color-picker');
                taskColorPicker.innerHTML = ''; // Clear existing options
                const allColors = [
                    'bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500',
                    'bg-pink-500', 'bg-indigo-500', 'bg-teal-500', 'bg-orange-500'
                ];
                allColors.forEach(colorClass => {
                    const div = document.createElement('div');
                    div.className = `color-option w-8 h-8 rounded-full cursor-pointer ${colorClass}`;
                    div.dataset.color = colorClass;
                    taskColorPicker.appendChild(div);
                });

                document.querySelectorAll('#color-picker .color-option').forEach(el => el.style.border = '2px solid transparent');
                const taskColorInput = document.getElementById('task-color');
                
                // Show/hide class-specific fields based on row
                if (row === 0) { // 'Class' row
                    classSpecificFields.classList.remove('hidden');
                    taskLocationTypeRadios.forEach(radio => {
                        radio.addEventListener('change', () => {
                            taskVenueInput.classList.toggle('hidden', radio.value !== 'In-person');
                        });
                    });
                } else {
                    classSpecificFields.classList.add('hidden');
                }


                if (task) {
                    document.getElementById('task-id').value = task.id;
                    document.getElementById('task-name').value = task.name;
                    taskColorInput.value = task.color;
                    taskCourseIdInput.value = task.courseId || '';
                    taskClassIdInput.value = task.classId || '';
                    taskStartTimeInput.value = task.startTime || '';
                    taskEndTimeInput.value = task.endTime || '';
                    
                    // Set location type radio and venue input
                    if (task.locationType) {
                        document.querySelector(`input[name="locationType"][value="${task.locationType}"]`).checked = true;
                        taskVenueInput.classList.toggle('hidden', task.locationType !== 'In-person');
                        taskVenueInput.value = task.venue || '';
                    } else {
                        document.querySelector(`input[name="locationType"][value="Online"]`).checked = true;
                        taskVenueInput.classList.add('hidden');
                        taskVenueInput.value = '';
                    }

                } else {
                    document.getElementById('task-id').value = '';
                    taskCourseIdInput.value = '';
                    taskClassIdInput.value = '';
                    taskStartTimeInput.value = '';
                    taskEndTimeInput.value = '';
                    document.querySelector(`input[name="locationType"][value="Online"]`).checked = true;
                    taskVenueInput.classList.add('hidden');
                    taskVenueInput.value = '';

                    // Pre-fill color if a course is active, otherwise default
                    taskColorInput.value = activeCourseColor; 
                }
                const selectedColorEl = document.querySelector(`#color-picker .color-option[data-color="${taskColorInput.value}"]`);
                if (selectedColorEl) selectedColorEl.style.border = '2px solid white';
            }

            function openLinkModal(link = null) {
                openModal(linkModal);
                const form = document.getElementById('link-form');
                form.reset();
                document.getElementById('delete-link-btn').classList.toggle('hidden', !link);
                document.getElementById('link-modal-title').textContent = link ? 'Edit Link' : 'Add New Link';

                if (link) {
                    document.getElementById('link-id').value = link.id;
                    document.getElementById('link-name').value = link.name;
                    document.getElementById('link-url').value = link.url;
                } else {
                    document.getElementById('link-id').value = '';
                }
            }

            // Open Course Modal (Now only for adding/editing course details, not classes)
            function openCourseModal(course = null) {
                openModal(courseModal);
                const form = document.getElementById('course-form');
                form.reset();
                document.getElementById('delete-course-btn').classList.toggle('hidden', !course);
                document.getElementById('course-modal-title').textContent = course ? 'Edit Course Details' : 'Add New Course';

                document.querySelectorAll('#course-color-picker .color-option').forEach(el => el.style.border = '2px solid transparent');
                const courseColorInput = document.getElementById('course-color');

                // Hide classes management section in this modal
                // courseClassesManagement.classList.add('hidden'); // This element is now removed from HTML

                if (course) {
                    document.getElementById('course-id').value = course.id;
                    document.getElementById('course-name').value = course.name;
                    courseColorInput.value = course.color;
                } else {
                    document.getElementById('course-id').value = '';
                    courseColorInput.value = 'bg-blue-500'; // Default color for new courses
                }
                const selectedColorEl = document.querySelector(`#course-color-picker .color-option[data-color="${courseColorInput.value}"]`);
                if (selectedColorEl) selectedColorEl.style.border = '2px solid white';
            }

            // NEW: Open Course Management Modal
            function openCourseManagementModal(course) {
                currentlyManagedCourseId = course.id;
                openModal(courseManagementModal);
                managedCourseNameDisplay.textContent = course.name;
                managedCourseColorDisplay.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary-color'); // Reset to default background
                managedCourseColorDisplay.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary-color'); // Reset text color
                managedCourseColorDisplay.textContent = `Color: ${course.color.replace('bg-', '')}`; // Display color name
                managedCourseColorDisplay.classList.add(course.color); // Add the actual color class for visual

                renderManagedCourseClasses(course.id);
            }

            // Render classes within the NEW course management modal
            function renderManagedCourseClasses(courseId) {
                const course = courses.find(c => c.id === courseId);
                managedCourseClassesList.innerHTML = '';
                if (!course || !course.classes || course.classes.length === 0) {
                    managedCourseClassesList.innerHTML = `<p class="themed-text-secondary text-sm">No classes added for this course.</p>`;
                    return;
                }

                course.classes.forEach(cls => {
                    const classItem = document.createElement('div');
                    classItem.className = `p-2 mb-2 rounded-md themed-bg-tertiary themed-text text-sm flex justify-between items-center cursor-pointer hover:bg-gray-600 transition`;
                    classItem.innerHTML = `
                        <div>
                            <p class="font-semibold">${cls.name} (${cls.type || 'N/A'})</p>
                            <p class="text-xs themed-text-secondary">
                                ${cls.startTime ? cls.startTime + (cls.endTime ? ` - ${cls.endTime}` : '') : ''}
                                ${cls.locationType ? (cls.startTime ? ' | ' : '') + cls.locationType : ''}
                                ${cls.locationType === 'In-person' && cls.venue ? `: ${cls.venue}` : ''}
                            </p>
                        </div>
                        <button class="delete-class-from-course-btn p-1 rounded-full bg-red-700 hover:bg-red-800 transition-colors" data-class-id="${cls.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    `;
                    classItem.addEventListener('click', () => openClassModal(courseId, cls));
                    classItem.querySelector('.delete-class-from-course-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteClass(courseId, cls.id);
                    });
                    managedCourseClassesList.appendChild(classItem);
                });
            }

            // Open Class Modal
            function openClassModal(courseId, classObj = null) {
                openModal(classModal);
                classForm.reset();
                classIdInput.value = '';
                classCourseParentIdInput.value = courseId;
                deleteClassBtn.classList.toggle('hidden', !classObj);
                classModalTitle.textContent = classObj ? 'Edit Class' : 'Add New Class';

                renderClassTypesSelect(); // Populate class types dropdown
                
                // Set up location type radio listener
                classLocationTypeRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        classVenueModal.classList.toggle('hidden', radio.value !== 'In-person');
                    });
                });

                if (classObj) {
                    classIdInput.value = classObj.id;
                    classNameInput.value = classObj.name;
                    classTypeSelect.value = classObj.type || classTypes[0];
                    classStartTimeModal.value = classObj.startTime || '';
                    classEndTimeModal.value = classObj.endTime || '';
                    
                    // Set location type radio and venue input
                    if (classObj.locationType) {
                        document.querySelector(`input[name="classLocationType"][value="${classObj.locationType}"]`).checked = true;
                        classVenueModal.classList.toggle('hidden', classObj.locationType !== 'In-person');
                        classVenueModal.value = classObj.venue || '';
                    } else {
                        document.querySelector(`input[name="classLocationType"][value="Online"]`).checked = true;
                        classVenueModal.classList.add('hidden');
                        classVenueModal.value = '';
                    }

                } else {
                    // Default for new class
                    classTypeSelect.value = classTypes[0];
                    document.querySelector(`input[name="classLocationType"][value="Online"]`).checked = true;
                    classVenueModal.classList.add('hidden');
                    classVenueModal.value = '';
                }
            }

            // Render Class Types in Select
            function renderClassTypesSelect() {
                classTypeSelect.innerHTML = '';
                classTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    classTypeSelect.appendChild(option);
                });
            }

            // Save Class
            function saveClass(e) {
                e.preventDefault();
                const courseId = classCourseParentIdInput.value;
                const id = classIdInput.value || `class-${Date.now()}`;
                const name = classNameInput.value.trim();
                const type = classTypeSelect.value;
                const startTime = classStartTimeModal.value;
                const endTime = classEndTimeModal.value;
                const locationType = document.querySelector('input[name="classLocationType"]:checked').value;
                const venue = classVenueModal.value.trim();

                if (!name) {
                    showMessageBox('Class name cannot be empty.');
                    return;
                }

                const course = courses.find(c => c.id === courseId);
                if (!course) {
                    showMessageBox('Error: Parent course not found.');
                    return;
                }

                if (!course.classes) {
                    course.classes = [];
                }

                const newClass = { id, name, type, startTime, endTime, locationType, venue };
                const existingClassIndex = course.classes.findIndex(cls => cls.id === id);

                if (existingClassIndex > -1) {
                    course.classes[existingClassIndex] = newClass;
                } else {
                    course.classes.push(newClass);
                }
                
                closeModal(classModal);
                renderManagedCourseClasses(courseId); // Re-render classes list in course management modal
                saveState();
            }

            // Delete Class
            function deleteClass(courseId, classId) {
                showMessageBox("Are you sure you want to delete this class? This will also remove all instances of this class from your timetable. Click OK to confirm.");
                document.getElementById('messageBox').querySelector('button').onclick = () => {
                    hideMessageBox();
                    const course = courses.find(c => c.id === courseId);
                    if (course) {
                        course.classes = course.classes.filter(cls => cls.id !== classId);
                        // Remove all tasks in the timetable that were instances of this class
                        Object.keys(tasks).forEach(key => {
                            tasks[key] = tasks[key].filter(task => !(task.courseId === courseId && task.classId === classId));
                        });
                        renderManagedCourseClasses(courseId); // Re-render classes list in course management modal
                        renderTimetable(); // Re-render timetable to reflect deleted tasks
                        saveState();
                    }
                    closeModal(classModal); // Close class modal if open
                };
            }

            // Manage Class Types
            function openClassTypeModal() {
                openModal(classTypeModal);
                renderClassTypesList();
            }

            function renderClassTypesList() {
                classTypesList.innerHTML = '';
                if (classTypes.length === 0) {
                    classTypesList.innerHTML = `<p class="themed-text-secondary text-sm">No custom types added.</p>`;
                    return;
                }
                classTypes.forEach(type => {
                    const typeItem = document.createElement('div');
                    typeItem.className = 'flex justify-between items-center p-2 mb-1 rounded-md themed-bg-tertiary themed-text text-sm';
                    typeItem.innerHTML = `
                        <span>${type}</span>
                        <button class="delete-custom-type-btn p-1 rounded-full bg-red-700 hover:bg-red-800 transition-colors" data-type="${type}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    `;
                    typeItem.querySelector('.delete-custom-type-btn').addEventListener('click', (e) => {
                        deleteClassType(e.currentTarget.dataset.type);
                    });
                    classTypesList.appendChild(typeItem);
                });
            }

            function addClassType() {
                const newType = newClassTypeNameInput.value.trim();
                if (newType && !classTypes.includes(newType)) {
                    classTypes.push(newType);
                    newClassTypeNameInput.value = '';
                    renderClassTypesList();
                    saveState();
                    renderClassTypesSelect(); // Update dropdowns
                } else if (classTypes.includes(newType)) {
                    showMessageBox('This class type already exists.');
                }
            }

            function deleteClassType(typeToDelete) {
                classTypes = classTypes.filter(type => type !== typeToDelete);
                renderClassTypesList();
                saveState();
                renderClassTypesSelect(); // Update dropdowns
            }

            // Manage Venues
            function openVenueModal() {
                openModal(venueModal);
                renderVenuesList();
            }

            function renderVenuesList() {
                venuesList.innerHTML = '';
                if (venues.length === 0) {
                    venuesList.innerHTML = `<p class="themed-text-secondary text-sm">No custom venues added.</p>`;
                    return;
                }
                venues.forEach(venue => {
                    const venueItem = document.createElement('div');
                    venueItem.className = 'flex justify-between items-center p-2 mb-1 rounded-md themed-bg-tertiary themed-text text-sm';
                    venueItem.innerHTML = `
                        <span>${venue}</span>
                        <button class="delete-custom-venue-btn p-1 rounded-full bg-red-700 hover:bg-red-800 transition-colors" data-venue="${venue}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    `;
                    venueItem.querySelector('.delete-custom-venue-btn').addEventListener('click', (e) => {
                        deleteVenue(e.currentTarget.dataset.venue);
                    });
                    venuesList.appendChild(venueItem);
                });
            }

            function addVenue() {
                const newVenue = newVenueNameInput.value.trim();
                if (newVenue && !venues.includes(newVenue)) {
                    venues.push(newVenue);
                    newVenueNameInput.value = '';
                    renderVenuesList();
                    saveState();
                } else if (venues.includes(newVenue)) {
                    showMessageBox('This venue already exists.');
                }
            }

            function deleteVenue(venueToDelete) {
                venues = venues.filter(venue => venue !== venueToDelete);
                renderVenuesList();
                saveState();
            }

            function openModal(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => modal.classList.add('active'), 10);
            }

            function closeModal(modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 300);
            }

            // --- Event Handlers & Logic ---
            document.getElementById('task-form').addEventListener('submit', handleTaskFormSubmit);
            document.getElementById('link-form').addEventListener('submit', handleLinkFormSubmit);
            document.getElementById('course-form').addEventListener('submit', handleCourseFormSubmit); 
            saveUpcomingTaskBtn.addEventListener('click', handleSaveUpcomingTask);
            classForm.addEventListener('submit', saveClass); // New event listener for class form

            // Event listeners for new modals
            // These buttons are now in course-management-modal
            // addClassBtn.addEventListener('click', () => {
            //     const courseId = document.getElementById('course-id').value;
            //     openClassModal(courseId);
            // });
            // manageClassTypesBtn.addEventListener('click', openClassTypeModal);
            // manageVenuesBtn.addEventListener('click', openVenueModal);

            addClassTypeBtn.addEventListener('click', addClassType);
            addVenueBtn.addEventListener('click', addVenue);
            closeClassTypeModalBtn.addEventListener('click', () => closeModal(classTypeModal));
            closeVenueModalBtn.addEventListener('click', () => closeModal(venueModal));
            cancelClassBtn.addEventListener('click', () => closeModal(classModal));
            addCustomTaskBtn.addEventListener('click', () => {
                closeModal(selectClassModal);
                openTaskModal(selectClassModal.dataset.day, selectClassModal.dataset.row); // Open task modal for custom task
            });
            cancelSelectClassModalBtn.addEventListener('click', () => closeModal(selectClassModal));

            // Course Management Modal Event Listeners
            editCourseDetailsBtn.addEventListener('click', () => {
                const course = courses.find(c => c.id === currentlyManagedCourseId);
                if (course) {
                    closeModal(courseManagementModal);
                    openCourseModal(course); // Open the original course modal for editing details
                }
            });

            addNewClassToCourseBtn.addEventListener('click', () => {
                openClassModal(currentlyManagedCourseId); // Open class modal for the currently managed course
            });

            manageClassTypesFromCourseMgmtBtn.addEventListener('click', openClassTypeModal);
            manageVenuesFromCourseMgmtBtn.addEventListener('click', openVenueModal);

            deleteCourseFromMgmtBtn.addEventListener('click', () => {
                deleteCourse(currentlyManagedCourseId);
                closeModal(courseManagementModal); // Close the management modal after deletion
            });

            closeCourseManagementModalBtn.addEventListener('click', () => {
                closeModal(courseManagementModal);
            });


            function handleTaskFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('task-id').value;
                const name = document.getElementById('task-name').value;
                const color = document.getElementById('task-color').value;
                const day = document.getElementById('hidden-task-day').value;
                const row = document.getElementById('hidden-task-row').value;
                const taskKey = `${currentWeek}-${day}-${row}`;

                // Class-specific fields
                const courseId = taskCourseIdInput.value || null;
                const classId = taskClassIdInput.value || null;
                const startTime = taskStartTimeInput.value || '';
                const endTime = taskEndTimeInput.value || '';
                const locationType = document.querySelector('input[name="locationType"]:checked').value;
                const venue = taskVenueInput.value || '';

                if (!tasks[taskKey]) tasks[taskKey] = [];
                
                const taskIndex = tasks[taskKey].findIndex(t => t.id === id);

                const newTask = { 
                    id: id || `task-${Date.now()}`, 
                    name, 
                    color, 
                    day, 
                    row, 
                    completed: false, 
                    courseId, 
                    classId, 
                    startTime, 
                    endTime, 
                    locationType, 
                    venue 
                };

                if (taskIndex > -1) { // Editing
                    tasks[taskKey][taskIndex] = { ...tasks[taskKey][taskIndex], ...newTask }; // Merge new data
                } else { // Adding
                    tasks[taskKey].push(newTask);
                }
                
                closeModal(taskModal);
                renderTimetable();
                saveState();
            }

            function handleLinkFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('link-id').value;
                const name = document.getElementById('link-name').value;
                let url = document.getElementById('link-url').value;

                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }

                const linkIndex = links.findIndex(l => l.id === id);

                if (linkIndex > -1) { // Editing
                    links[linkIndex] = { id, name, url };
                } else { // Adding
                    links.push({ id: `link-${Date.now()}`, name, url });
                }

                closeModal(linkModal);
                renderLinks();
                saveState();
            }

            // Handle Course Form Submit (for adding/editing course name/color)
            function handleCourseFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('course-id').value;
                const name = document.getElementById('course-name').value;
                const color = document.getElementById('course-color').value;

                const courseIndex = courses.findIndex(c => c.id === id);

                if (courseIndex > -1) { // Editing existing course details
                    courses[courseIndex].name = name;
                    courses[courseIndex].color = color;
                    // If the edited course was active, update active color
                    if (activeCourseId === id) {
                        activeCourseColor = color;
                    }
                    closeModal(courseModal); // Close the course details modal
                    // Re-open course management modal to show updated details
                    const updatedCourse = courses.find(c => c.id === id);
                    if (updatedCourse) {
                        openCourseManagementModal(updatedCourse);
                    }
                } else { // Adding new course
                    const newCourse = { id: `course-${Date.now()}`, name, color, classes: [] };
                    courses.push(newCourse);
                    closeModal(courseModal); // Close the add new course modal
                    openCourseManagementModal(newCourse); // Open management for the new course
                }
                
                renderCourses(); // Re-render course cards
                saveState();
            }

            function handleSaveUpcomingTask() {
                const name = upcomingTaskNameInput.value.trim();
                const targetWeek = parseInt(upcomingTaskTargetWeekInput.value, 10);
                const targetDay = parseInt(upcomingTaskTargetDaySelect.value, 10);

                if (!name) {
                    showMessageBox("Please enter a task name for the upcoming task.");
                    return;
                }
                if (isNaN(targetWeek) || targetWeek < 1) {
                    showMessageBox("Please enter a valid target week for the upcoming task.");
                    return;
                }

                const newUpcomingTask = {
                    id: `upcoming-task-${Date.now()}`,
                    name,
                    targetWeek,
                    targetDay,
                    color: 'bg-blue-500', // Default color for upcoming tasks for now
                    type: 'Class', // Upcoming tasks always go to 'Class' row
                    startTime: '',
                    endTime: '',
                    location: ''
                };
                upcomingTasks.push(newUpcomingTask);
                upcomingTaskNameInput.value = ''; // Clear input
                upcomingTaskTargetWeekInput.value = currentWeek; // Reset to current week
                upcomingTaskTargetDaySelect.value = '0'; // Reset to Saturday
                renderUpcomingTasks();
                renderInfoBoxContent(); // Update info box
                saveState();
                showMessageBox('Upcoming task saved!');
            }
            
            document.getElementById('delete-task-btn').onclick = () => {
                const id = document.getElementById('task-id').value;
                const day = document.getElementById('hidden-task-day').value;
                const row = document.getElementById('hidden-task-row').value;
                const taskKey = `${currentWeek}-${day}-${row}`;

                if (tasks[taskKey]) {
                    tasks[taskKey] = tasks[taskKey].filter(t => t.id !== id);
                }
                closeModal(taskModal);
                renderTimetable();
                saveState();
            };
            
            document.getElementById('delete-link-btn').onclick = () => {
                const id = document.getElementById('link-id').value;
                links = links.filter(l => l.id !== id);
                closeModal(linkModal);
                renderLinks();
                saveState();
            };

            // This delete course button is for the `course-modal` (add/edit course details)
            // It will be hidden unless editing an existing course.
            document.getElementById('delete-course-btn').onclick = () => {
                const id = document.getElementById('course-id').value;
                deleteCourse(id); 
                closeModal(courseModal); // Close the course details modal
            };

            function deleteLink(id) {
                links = links.filter(l => l.id !== id);
                renderLinks();
                saveState();
            }

            function deleteCourse(id) {
                showMessageBox("Are you sure you want to delete this course? This will also remove all its associated classes and all instances of those classes from your timetable. Click OK to confirm.");
                document.getElementById('messageBox').querySelector('button').onclick = () => {
                    hideMessageBox();
                    courses = courses.filter(c => c.id !== id);
                    // Also remove any tasks associated with this course
                    Object.keys(tasks).forEach(key => {
                        tasks[key] = tasks[key].filter(t => t.courseId !== id);
                    });

                    // If the deleted course was active, clear selection
                    if (activeCourseId === id) {
                        clearCourseSelection();
                    }
                    renderCourses();
                    renderTimetable(); // Re-render timetable to reflect task deletions
                    saveState();
                };
            }

            toggleDeleteLinkBtn.addEventListener('click', () => {
                isLinkDeleteMode = !isLinkDeleteMode;
                toggleDeleteLinkBtn.textContent = isLinkDeleteMode ? 'Done' : 'Delete';
                toggleDeleteLinkBtn.classList.toggle('bg-red-600', isLinkDeleteMode);
                toggleDeleteLinkBtn.classList.toggle('hover:bg-red-700', isLinkDeleteMode);
                toggleDeleteLinkBtn.classList.toggle('bg-gray-600', !isLinkDeleteMode);
                toggleDeleteLinkBtn.classList.toggle('hover:bg-gray-700', !isLinkDeleteMode);
                renderLinks();
            });

            // Toggle Delete Course Mode
            toggleDeleteCourseBtn.addEventListener('click', () => {
                isCourseDeleteMode = !isCourseDeleteMode;
                toggleDeleteCourseBtn.textContent = isCourseDeleteMode ? 'Done' : 'Delete';
                toggleDeleteCourseBtn.classList.toggle('bg-red-600', isCourseDeleteMode);
                toggleDeleteCourseBtn.classList.toggle('hover:bg-red-700', isCourseDeleteMode);
                toggleDeleteCourseBtn.classList.toggle('bg-gray-600', !isCourseDeleteMode);
                toggleDeleteCourseBtn.classList.toggle('hover:bg-gray-700', !isCourseDeleteMode);
                if (isCourseDeleteMode) { // If entering delete mode, clear any active course selection
                    activeCourseId = null;
                    activeCourseColor = 'bg-blue-500';
                }
                renderCourses();
                saveState();
            });

            document.getElementById('cancel-btn').onclick = () => closeModal(taskModal);
            document.getElementById('cancel-link-btn').onclick = () => closeModal(linkModal);
            document.getElementById('cancel-course-btn').onclick = () => closeModal(courseModal); 
            closeUpcomingTasksModalBtn.onclick = () => closeModal(upcomingTasksDetailsModal);


            document.getElementById('add-link-btn').onclick = () => openLinkModal();
            document.getElementById('add-course-btn').onclick = () => openCourseModal(); 
            document.getElementById('clear-course-selection-btn').onclick = () => clearCourseSelection(); 

            document.getElementById('color-picker').addEventListener('click', (e) => {
                if (e.target.classList.contains('color-option')) {
                    document.querySelectorAll('#color-picker .color-option').forEach(el => el.style.border = '2px solid transparent');
                    e.target.style.border = '2px solid white';
                    document.getElementById('task-color').value = e.target.dataset.color;
                }
            });

            // Course Color Picker
            document.getElementById('course-color-picker').addEventListener('click', (e) => {
                if (e.target.classList.contains('color-option')) {
                    document.querySelectorAll('#course-color-picker .color-option').forEach(el => el.style.border = '2px solid transparent');
                    e.target.style.border = '2px solid white';
                    document.getElementById('course-color').value = e.target.dataset.color;
                }
            });
            
            function toggleTaskCompletion(taskId) {
                for (const key in tasks) {
                    const task = tasks[key].find(t => t.id === taskId);
                    if (task) {
                        task.completed = !task.completed;
                        break;
                    }
                }
                renderTimetable();
                saveState();
            }

            // --- Theme Toggle ---
            themeToggle.onclick = () => {
                document.body.classList.toggle('light-mode');
                updateThemeIcon();
                saveState();
            };

            function updateThemeIcon() {
                const isLight = document.body.classList.contains('light-mode');
                document.getElementById('theme-icon-sun').classList.toggle('hidden', !isLight);
                document.getElementById('theme-icon-moon').classList.toggle('hidden', isLight);
            }

            // --- Week Navigation & Goal Saving ---
            document.getElementById('prev-week').onclick = () => { 
                currentWeek--; 
                if (!weekDates[currentWeek]) {
                    const prevSaturday = new Date(getSaturdayDateForWeek(currentWeek + 1));
                    prevSaturday.setDate(prevSaturday.getDate() - 7);
                    setSaturdayDateForWeek(currentWeek, prevSaturday);
                }
                renderTimetable(); 
                saveState(); 
                renderInfoBoxContent(); // Update info box
            };
            document.getElementById('next-week').onclick = () => { 
                currentWeek++; 
                if (!weekDates[currentWeek]) {
                    const nextSaturday = new Date(getSaturdayDateForWeek(currentWeek - 1));
                    nextSaturday.setDate(nextSaturday.getDate() + 7);
                    setSaturdayDateForWeek(currentWeek, nextSaturday);
                }
                renderTimetable(); 
                saveState(); 
                renderInfoBoxContent(); // Update info box
            };
            document.getElementById('weekly-goal').addEventListener('input', saveState);

            // --- Reset Functionality ---
            document.getElementById('reset-btn').onclick = () => openModal(resetModal);
            document.getElementById('cancel-reset-btn').onclick = () => closeModal(resetModal);

            document.getElementById('clear-current-week-btn').onclick = () => {
                const currentWeekKeys = Object.keys(tasks).filter(key => key.startsWith(`${currentWeek}-`));
                currentWeekKeys.forEach(key => delete tasks[key]);
                document.getElementById('weekly-goal').value = ''; // Clear goal for current week
                closeModal(resetModal);
                renderTimetable();
                saveState();
            };

            document.getElementById('clear-all-weeks-btn').onclick = () => {
                showMessageBox("Are you sure you want to clear ALL tasks from ALL weeks and ALL saved week dates? This cannot be undone unless you have exported your data. Click OK to proceed.");
                document.getElementById('messageBox').querySelector('button').onclick = () => {
                    hideMessageBox();
                    tasks = {}; // Clear all tasks
                    weekDates = {}; // Clear all saved dates
                    upcomingTasks = []; // Clear all upcoming tasks
                    selectedDay = { week: null, dayIndex: null }; // Reset selected day
                    document.getElementById('weekly-goal').value = ''; // Clear goal for current week
                    setWeekToCurrentDate(currentWeek); // Reset current week's date to today
                    closeModal(resetModal);
                    renderTimetable();
                    renderUpcomingTasks(); // Re-render upcoming tasks
                    renderInfoBoxContent(); // Update info box
                    saveState();
                };
            };

            // --- Export/Import Functionality ---
            exportDataBtn.addEventListener('click', () => {
                // This object contains ALL data and settings that will be exported.
                // It includes timetable tasks, week dates, quick links, courses, upcoming tasks,
                // selected day, active course, delete mode status, current week, weekly goal,
                // custom background image and blur, animation level, displayed upcoming task,
                // and custom class types and venues.
                const dataToExport = {
                    tasks: tasks,
                    weekDates: weekDates,
                    links: links, 
                    courses: courses, 
                    upcomingTasks: upcomingTasks, 
                    selectedDay: selectedDay, 
                    activeCourseId: activeCourseId, 
                    activeCourseColor: activeCourseColor, 
                    isCourseDeleteMode: isCourseDeleteMode, 
                    currentWeek: currentWeek, 
                    weeklyGoal: document.getElementById('weekly-goal').value, 
                    customBackground: localStorage.getItem('customBackground'), 
                    blurAmount: localStorage.getItem('blurAmount'), 
                    animationLevel: animationLevel, 
                    displayedUpcomingTaskId: displayedUpcomingTaskId, 
                    classTypes: classTypes,
                    venues: venues
                };
                const jsonString = JSON.stringify(dataToExport, null, 2); // Pretty print JSON

                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `timetable_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            importDataBtn.addEventListener('click', () => {
                backgroundUploadInput.value = null; // Clear any previously selected file
                importDataInput.click(); // Programmatically click the hidden file input
            });

            importDataInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                showMessageBox("Importing data will OVERWRITE your current timetable tasks, links, and dates. Are you sure you want to proceed? Click OK to confirm.");
                document.getElementById('messageBox').querySelector('button').onclick = () => {
                    hideMessageBox();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            // Overwrite global state with imported data
                            tasks = importedData.tasks || {};
                            weekDates = importedData.weekDates || {};
                            links = importedData.links || [];
                            courses = importedData.courses || []; 
                            upcomingTasks = importedData.upcomingTasks || [];
                            selectedDay = importedData.selectedDay !== undefined ? importedData.selectedDay : { week: null, dayIndex: null };
                            activeCourseId = importedData.activeCourseId !== undefined ? importedData.activeCourseId : null; 
                            activeCourseColor = importedData.activeCourseColor || 'bg-blue-500'; 
                            isCourseDeleteMode = importedData.isCourseDeleteMode !== undefined ? importedData.isCourseDeleteMode : false; 
                            currentWeek = importedData.currentWeek !== undefined ? importedData.currentWeek : 1;
                            document.getElementById('weekly-goal').value = importedData.weeklyGoal || '';
                            displayedUpcomingTaskId = importedData.displayedUpcomingTaskId !== undefined ? importedData.displayedUpcomingTaskId : null;
                            classTypes = importedData.classTypes || ['Lecture', 'Workshop', 'Tutorial', 'LAB'];
                            venues = importedData.venues || [];
                            
                            // Apply imported custom background and blur
                            if (importedData.customBackground) {
                                document.body.style.backgroundImage = `url('${importedData.customBackground}')`;
                                localStorage.setItem('customBackground', importedData.customBackground);
                                document.body.classList.add('custom-background-active');
                                blurSlider.disabled = false;
                                const blurValue = importedData.blurAmount ? parseFloat(importedData.blurAmount) : 5;
                                blurSlider.value = blurValue;
                                document.body.style.setProperty('--current-blur-amount', `${blurValue}px`);
                                localStorage.setItem('blurAmount', blurValue);
                            } else {
                                document.body.style.backgroundImage = '';
                                localStorage.removeItem('customBackground');
                                document.body.classList.remove('custom-background-active');
                                blurSlider.disabled = true;
                                blurSlider.value = 0;
                                document.body.style.setProperty('--current-blur-amount', `0px`);
                                localStorage.removeItem('blurAmount');
                            }

                            // Apply imported animation level
                            animationLevel = importedData.animationLevel || 'normal';
                            applyAnimationLevel(animationLevel);

                            saveState(); // Save imported data to local storage
                            renderTimetable(); // Re-render the UI with new data
                            renderLinks(); // Re-render quick links
                            renderCourses(); // Re-render courses
                            renderUpcomingTasks(); // Re-render upcoming tasks
                            renderInfoBoxContent(); // Update info box
                            showMessageBox('Data imported successfully!');

                        } catch (error) {
                            showMessageBox('Error importing data. Please ensure it is a valid JSON file. Error: ' + error.message);
                            console.error('Error parsing imported JSON:', error);
                        } finally {
                            event.target.value = null; // Clear the selected file to allow re-selection
                        }
                    };
                    reader.onerror = () => {
                        showMessageBox('Failed to read file.');
                        event.target.value = null; // Clear the selected file
                    };
                    reader.readAsText(file);
                };
            });

            // --- Background Options and Upload Functionality ---
            uploadBackgroundBtn.addEventListener('click', () => {
                openModal(backgroundOptionsModal); // Open the new options modal
            });

            revertBackgroundBtn.addEventListener('click', () => {
                document.body.style.backgroundImage = ''; // Remove custom background
                localStorage.removeItem('customBackground'); // Clear from local storage
                document.body.classList.remove('custom-background-active'); // Remove class
                blurSlider.disabled = true; // Disable slider
                blurSlider.value = 0; // Reset slider
                document.body.style.setProperty('--current-blur-amount', `0px`); // Reset blur CSS variable
                localStorage.removeItem('blurAmount'); // Remove blur amount from local storage
                saveState(); // Save the state
                closeModal(backgroundOptionsModal); // Close the modal
                showMessageBox('Background reverted to default!');
            });

            uploadNewBackgroundBtn.addEventListener('click', () => {
                backgroundUploadInput.click(); // Trigger the file input
                closeModal(backgroundOptionsModal); // Close the modal
            });

            cancelBackgroundOptionsBtn.addEventListener('click', () => {
                closeModal(backgroundOptionsModal); // Close the modal
            });

            backgroundUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.body.style.backgroundImage = `url('${e.target.result}')`;
                        document.body.classList.add('custom-background-active'); // Add class to enable blur
                        blurSlider.disabled = false; // Enable slider
                        // Set a default blur if none was previously set, or keep existing
                        const currentBlur = localStorage.getItem('blurAmount') || '5';
                        blurSlider.value = currentBlur;
                        document.body.style.setProperty('--current-blur-amount', `${currentBlur}px`);
                        saveState();
                        showMessageBox('Background uploaded successfully!');
                    };
                    reader.onerror = () => {
                        showMessageBox('Error loading background image.');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // --- Blur Slider Event Listener ---
            blurSlider.addEventListener('input', () => {
                const blurValue = blurSlider.value;
                document.body.style.setProperty('--current-blur-amount', `${blurValue}px`);
                saveState(); // Save the new blur amount
            });

            // --- Animation Settings Logic ---
            animationSettingsBtn.addEventListener('click', () => {
                openModal(animationSettingsModal);
            });

            animationNormalBtn.addEventListener('click', () => {
                setAnimationLevel('normal');
            });

            animationReducedBtn.addEventListener('click', () => {
                setAnimationLevel('reduced');
            });

            animationNoneBtn.addEventListener('click', () => {
                setAnimationLevel('none');
            });

            cancelAnimationSettingsBtn.addEventListener('click', () => {
                closeModal(animationSettingsModal);
            });

            function setAnimationLevel(level) {
                animationLevel = level;
                applyAnimationLevel(level);
                saveState();
                closeModal(animationSettingsModal);
                // Removed showMessageBox
            }

            function applyAnimationLevel(level) {
                document.body.classList.remove('animation-normal', 'animation-reduced', 'animation-none');
                document.body.classList.add(`animation-${level}`);
            }

            // --- Sidebar Logic ---
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });

            closeSidebarBtn.addEventListener('click', () => {
                sidebar.classList.remove('open');
            });

            toggleUpcomingTasksBtn.addEventListener('click', () => {
                upcomingTasksContent.classList.toggle('open');
                upcomingTasksToggleIcon.classList.toggle('rotate-180'); // Rotate arrow icon
            });

            // --- Info Box Interaction ---
            infoBox.addEventListener('click', () => {
                openUpcomingTasksDetailsModal();
            });

            infoBoxClearSelectionBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the modal when clearing selection
                displayedUpcomingTaskId = null;
                renderInfoBoxContent();
            });

            // --- Select Class/Custom Task Modal Logic ---
            let currentTaskDay, currentTaskRow; // To pass context to task modal

            function openSelectClassModal(day, row) {
                currentTaskDay = day;
                currentTaskRow = row;
                selectClassModal.dataset.day = day; // Store for custom task button
                selectClassModal.dataset.row = row; // Store for custom task button
                renderCoursesForSelection();
                openModal(selectClassModal);
            }

            function renderCoursesForSelection() {
                selectCourseList.innerHTML = '';
                if (courses.length === 0) {
                    selectCourseList.innerHTML = `<p class="themed-text-secondary text-sm">No courses available. Add some in 'My Courses' section.</p>`;
                    return;
                }

                courses.forEach(course => {
                    const courseDiv = document.createElement('div');
                    courseDiv.className = `p-2 mb-2 rounded-md themed-bg-tertiary themed-text cursor-pointer hover:bg-gray-600 transition`;
                    courseDiv.innerHTML = `<p class="font-semibold">${course.name}</p>`;
                    
                    const classesListDiv = document.createElement('div');
                    classesListDiv.className = 'ml-4 mt-2 space-y-1 hidden'; // Initially hidden
                    
                    if (course.classes && course.classes.length > 0) {
                        course.classes.forEach(cls => {
                            const classItem = document.createElement('div');
                            classItem.className = `select-class-item p-2 rounded-md ${course.color} text-white text-sm cursor-pointer hover:opacity-90 transition`;
                            
                            // Construct the details string
                            let detailsText = `${cls.type || 'N/A'}`;
                            if (cls.startTime) {
                                detailsText += ` | ${cls.startTime}`;
                                if (cls.endTime) detailsText += ` - ${cls.endTime}`;
                            }
                            if (cls.locationType) {
                                detailsText += ` | ${cls.locationType}`;
                                if (cls.locationType === 'In-person' && cls.venue) {
                                    detailsText += `: ${cls.venue}`;
                                }
                            }

                            classItem.innerHTML = `
                                <p class="class-name">${cls.name}</p>
                                <p class="class-details-text">${detailsText}</p>
                            `;

                            classItem.addEventListener('click', (e) => {
                                e.stopPropagation(); // Prevent courseDiv click
                                closeModal(selectClassModal);
                                // Open task modal with pre-filled class data
                                openTaskModal(currentTaskDay, currentTaskRow, {
                                    name: cls.name,
                                    color: course.color,
                                    courseId: course.id,
                                    classId: cls.id,
                                    startTime: cls.startTime,
                                    endTime: cls.endTime,
                                    locationType: cls.locationType,
                                    venue: cls.venue
                                });
                            });
                            classesListDiv.appendChild(classItem);
                        });
                    } else {
                        const noClassesMsg = document.createElement('p');
                        noClassesMsg.className = 'text-xs themed-text-secondary mt-1';
                        noClassesMsg.textContent = 'No classes defined for this course.';
                        classesListDiv.appendChild(noClassesMsg);
                    }

                    courseDiv.addEventListener('click', () => {
                        classesListDiv.classList.toggle('hidden');
                    });

                    selectCourseList.appendChild(courseDiv);
                    selectCourseList.appendChild(classesListDiv);
                });
            }


            // --- Initial Load ---
            loadState();
            renderTimetable();
            renderLinks();
            renderCourses(); 
            renderUpcomingTasks();
            renderInfoBoxContent(); // Initial render of info box
        });
    </script>
</body>
</html>
